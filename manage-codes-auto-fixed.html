<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SCL-90 å…‘æ¢ç ç®¡ç†å·¥å…· - ä¿®å¤ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* è‡ªå®šä¹‰æ»šåŠ¨æ¡ */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
    </style>
</head>
<body class="bg-gray-100 p-4 sm:p-8">
    <div class="max-w-6xl mx-auto">
        <!-- å®‰å…¨è­¦å‘Š -->
        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6">
            <h3 class="text-yellow-800 font-semibold mb-2">ğŸ” è‡ªåŠ¨æ›´æ–°åŠŸèƒ½è¯´æ˜</h3>
            <div class="text-yellow-700 text-sm space-y-1">
                <p>â€¢ éœ€è¦æä¾›GitHub Personal Access Tokenç”¨äºè‡ªåŠ¨æ›´æ–°</p>
                <p>â€¢ Tokenåªä¼šä¿å­˜åœ¨æœ¬åœ°æµè§ˆå™¨ï¼Œä¸ä¼šä¸Šä¼ åˆ°æœåŠ¡å™¨</p>
                <p>â€¢ å»ºè®®åˆ›å»ºæœ€å°æƒé™çš„Tokenï¼ˆä»…repoæƒé™ï¼‰</p>
            </div>
        </div>

        <h1 class="text-2xl sm:text-3xl font-bold mb-6 sm:mb-8 text-center">SCL-90 å…‘æ¢ç ç®¡ç†å·¥å…· (ä¿®å¤ç‰ˆ)</h1>

        <!-- GitHubè®¾ç½® -->
        <div class="bg-white rounded-lg shadow-lg p-4 sm:p-6 mb-6">
            <h2 class="text-lg sm:text-xl font-semibold mb-4">GitHub è®¾ç½®</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label class="block text-sm font-medium mb-2">GitHubç”¨æˆ·å</label>
                    <input
                        type="text"
                        id="githubUsername"
                        class="w-full p-2 border rounded"
                        placeholder="your-username"
                    />
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">ä»“åº“åç§°</label>
                    <input
                        type="text"
                        id="githubRepo"
                        class="w-full p-2 border rounded"
                        placeholder="your-repo"
                    />
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Access Token</label>
                    <input
                        type="password"
                        id="githubToken"
                        class="w-full p-2 border rounded"
                        placeholder="ghp_xxxxxxxxxxxx"
                    />
                </div>
            </div>
            <div class="mt-4">
                <button
                    onclick="testGitHubConnection()"
                    class="bg-blue-500 text-white py-2 px-4 rounded hover:bg-blue-600"
                >
                    æµ‹è¯•GitHubè¿æ¥
                </button>
                <button
                    onclick="saveGitHubSettings()"
                    class="ml-2 bg-green-500 text-white py-2 px-4 rounded hover:bg-green-600"
                >
                    ä¿å­˜è®¾ç½®åˆ°æœ¬åœ°
                </button>
            </div>
            <div id="connectionStatus" class="mt-2 text-sm"></div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-6">
            <!-- ç”Ÿæˆå…‘æ¢ç  -->
            <div class="bg-white rounded-lg shadow-lg p-4 sm:p-6">
                <h2 class="text-lg sm:text-xl font-semibold mb-4">æ‰¹é‡ç”Ÿæˆå…‘æ¢ç </h2>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">æ•°é‡</label>
                        <input
                            type="number"
                            id="generateCount"
                            class="w-full p-2 border rounded"
                            value="10"
                            min="1"
                            max="100"
                        />
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">æ‰¹æ¬¡</label>
                        <input
                            type="text"
                            id="batchName"
                            class="w-full p-2 border rounded"
                            value="auto2024"
                        />
                    </div>
                    <div class="bg-blue-50 p-3 rounded">
                        <p class="text-sm text-blue-700">
                            <strong>å…‘æ¢ç æ ¼å¼ï¼š</strong>10ä½å­—æ¯æ•°å­—æ··åˆï¼ˆå¦‚ï¼šA3B7K9M2N8ï¼‰
                        </p>
                    </div>
                    <button
                        onclick="generateAndUploadCodes()"
                        class="w-full bg-green-500 text-white py-2 px-4 rounded hover:bg-green-600"
                        id="generateButton"
                    >
                        ç”Ÿæˆå¹¶è‡ªåŠ¨ä¸Šä¼ åˆ°GitHub
                    </button>
                </div>
            </div>

            <!-- æµ‹è¯•å’ŒåŒæ­¥ -->
            <div class="bg-white rounded-lg shadow-lg p-4 sm:p-6">
                <h2 class="text-lg sm:text-xl font-semibold mb-4">æµ‹è¯•å’ŒåŒæ­¥</h2>
                <div class="space-y-4">
                    <button
                        onclick="testAddRecord()"
                        class="w-full bg-yellow-500 text-white py-2 px-4 rounded hover:bg-yellow-600"
                    >
                        æ·»åŠ æµ‹è¯•è®°å½•
                    </button>
                    <button
                        onclick="testSyncFunction()"
                        class="w-full bg-blue-500 text-white py-2 px-4 rounded hover:bg-blue-600"
                    >
                        æµ‹è¯•åŒæ­¥åŠŸèƒ½
                    </button>
                    <button
                        onclick="syncUsedCodes()"
                        class="w-full bg-orange-500 text-white py-2 px-4 rounded hover:bg-orange-600"
                    >
                        åŒæ­¥ä½¿ç”¨è®°å½•åˆ°GitHub
                    </button>
                </div>
            </div>
        </div>

        <!-- æ“ä½œæ—¥å¿— -->
        <div class="mt-6 sm:mt-8 bg-white rounded-lg shadow-lg p-4 sm:p-6">
            <h2 class="text-lg sm:text-xl font-semibold mb-4">æ“ä½œæ—¥å¿—</h2>
            <div id="operationLog" class="space-y-2 max-h-60 overflow-y-auto text-sm font-mono bg-gray-50 p-4 rounded">
                <div class="text-gray-500">ç­‰å¾…æ“ä½œ...</div>
            </div>
            <button
                onclick="clearLog()"
                class="mt-2 bg-gray-500 text-white py-1 px-3 rounded text-sm"
            >
                æ¸…ç©ºæ—¥å¿—
            </button>
        </div>

        <!-- ç»“æœæ˜¾ç¤º -->
        <div id="result" class="mt-6 p-4 border rounded-lg hidden">
            <h3 class="font-semibold mb-2">æ“ä½œç»“æœï¼š</h3>
            <div id="resultContent"></div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let githubSettings = {
            username: '',
            repo: '',
            token: ''
        };

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('load', () => {
            loadSavedSettings();
            addLog('ğŸš€ é¡µé¢åŠ è½½å®Œæˆ');
        });

        // åŠ è½½ä¿å­˜çš„è®¾ç½®
        function loadSavedSettings() {
            try {
                const saved = localStorage.getItem('githubSettings');
                if (saved) {
                    githubSettings = JSON.parse(saved);
                    document.getElementById('githubUsername').value = githubSettings.username || '';
                    document.getElementById('githubRepo').value = githubSettings.repo || '';
                    document.getElementById('githubToken').value = githubSettings.token || '';
                    addLog('âœ… å·²åŠ è½½ä¿å­˜çš„GitHubè®¾ç½®');
                }
            } catch (error) {
                addLog(`âŒ åŠ è½½è®¾ç½®å¤±è´¥: ${error.message}`);
            }
        }

        // ä¿å­˜GitHubè®¾ç½®
        function saveGitHubSettings() {
            githubSettings = {
                username: document.getElementById('githubUsername').value.trim(),
                repo: document.getElementById('githubRepo').value.trim(),
                token: document.getElementById('githubToken').value.trim()
            };

            if (!githubSettings.username || !githubSettings.repo || !githubSettings.token) {
                showResult('error', 'è¯·å¡«å†™å®Œæ•´çš„GitHubè®¾ç½®ä¿¡æ¯');
                return;
            }

            try {
                localStorage.setItem('githubSettings', JSON.stringify(githubSettings));
                showResult('success', 'GitHubè®¾ç½®å·²ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨');
                addLog('âœ… GitHubè®¾ç½®å·²ä¿å­˜');
            } catch (error) {
                showResult('error', 'ä¿å­˜è®¾ç½®å¤±è´¥');
                addLog(`âŒ ä¿å­˜å¤±è´¥: ${error.message}`);
            }
        }

        // æµ‹è¯•GitHubè¿æ¥
        async function testGitHubConnection() {
            const username = document.getElementById('githubUsername').value.trim();
            const repo = document.getElementById('githubRepo').value.trim();
            const token = document.getElementById('githubToken').value.trim();

            if (!username || !repo || !token) {
                showConnectionStatus('âŒ è¯·å¡«å†™å®Œæ•´çš„GitHubè®¾ç½®ä¿¡æ¯', 'error');
                return;
            }

            addLog('ğŸ”„ æµ‹è¯•GitHubè¿æ¥...');
            showConnectionStatus('ğŸ”„ æµ‹è¯•ä¸­...', 'info');

            try {
                const response = await fetch(`https://api.github.com/repos/${username}/${repo}`, {
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                if (response.ok) {
                    const repoData = await response.json();
                    showConnectionStatus(`âœ… è¿æ¥æˆåŠŸï¼ä»“åº“ï¼š${repoData.full_name}`, 'success');
                    addLog('âœ… GitHubè¿æ¥æµ‹è¯•æˆåŠŸ');
                } else {
                    showConnectionStatus('âŒ è¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç”¨æˆ·åã€ä»“åº“åå’ŒToken', 'error');
                    addLog(`âŒ GitHubè¿æ¥å¤±è´¥: ${response.status}`);
                }
            } catch (error) {
                showConnectionStatus('âŒ ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥', 'error');
                addLog(`âŒ ç½‘ç»œé”™è¯¯: ${error.message}`);
            }
        }

        // æ˜¾ç¤ºè¿æ¥çŠ¶æ€
        function showConnectionStatus(message, type) {
            const statusDiv = document.getElementById('connectionStatus');
            const colorClass = type === 'success' ? 'text-green-600' : type === 'error' ? 'text-red-600' : 'text-blue-600';
            statusDiv.innerHTML = `<span class="${colorClass}">${message}</span>`;
        }

        // æ·»åŠ æµ‹è¯•è®°å½•
        function testAddRecord() {
            addLog('ğŸ§ª å¼€å§‹æ·»åŠ æµ‹è¯•è®°å½•...');

            try {
                const testRecord = {
                    code: `TEST${Date.now().toString().slice(-6)}`,
                    usedAt: new Date().toISOString(),
                    userAgent: navigator.userAgent,
                    ip: 'test-local'
                };

                let localUsedCodes = [];
                const stored = localStorage.getItem('usedCodes');
                if (stored) {
                    localUsedCodes = JSON.parse(stored);
                }

                localUsedCodes.push(testRecord);
                localStorage.setItem('usedCodes', JSON.stringify(localUsedCodes));

                showResult('success', `å·²æ·»åŠ æµ‹è¯•è®°å½•: ${testRecord.code}`);
                addLog(`ğŸ§ª æ·»åŠ æµ‹è¯•è®°å½•: ${testRecord.code}`);
                addLog(`ğŸ“Š å½“å‰localStorageä¸­å…±æœ‰ ${localUsedCodes.length} æ¡è®°å½•`);

            } catch (error) {
                showResult('error', `æ·»åŠ æµ‹è¯•è®°å½•å¤±è´¥: ${error.message}`);
                addLog(`âŒ æ·»åŠ æµ‹è¯•è®°å½•å¤±è´¥: ${error.message}`);
            }
        }

        // æµ‹è¯•åŒæ­¥åŠŸèƒ½
        function testSyncFunction() {
            addLog('ğŸ” å¼€å§‹æµ‹è¯•åŒæ­¥åŠŸèƒ½...');

            try {
                // æ£€æŸ¥GitHubè®¾ç½®
                if (!githubSettings.username || !githubSettings.repo || !githubSettings.token) {
                    addLog('âŒ GitHubè®¾ç½®ä¸å®Œæ•´');
                    showResult('error', 'è¯·å…ˆé…ç½®GitHubè®¾ç½®');
                    return;
                }

                // æ£€æŸ¥localStorage
                const stored = localStorage.getItem('usedCodes');
                if (!stored) {
                    addLog('âŒ localStorageä¸­æ²¡æœ‰ä½¿ç”¨è®°å½•');
                    showResult('error', 'è¯·å…ˆæ·»åŠ æµ‹è¯•è®°å½•');
                    return;
                }

                const usedCodes = JSON.parse(stored);
                addLog(`âœ… æ‰¾åˆ° ${usedCodes.length} æ¡æœ¬åœ°è®°å½•`);

                showResult('success', 'åŒæ­¥åŠŸèƒ½æµ‹è¯•é€šè¿‡ï¼Œå¯ä»¥å¼€å§‹åŒæ­¥');
                addLog('âœ… åŒæ­¥åŠŸèƒ½æµ‹è¯•å®Œæˆ');

            } catch (error) {
                addLog(`âŒ æµ‹è¯•å¤±è´¥: ${error.message}`);
                showResult('error', `æµ‹è¯•å¤±è´¥: ${error.message}`);
            }
        }

        // åŒæ­¥ä½¿ç”¨è®°å½•
        async function syncUsedCodes() {
            addLog('ğŸ”„ å¼€å§‹åŒæ­¥ä½¿ç”¨è®°å½•...');

            // æ£€æŸ¥GitHubè®¾ç½®
            if (!githubSettings.username || !githubSettings.repo || !githubSettings.token) {
                showResult('error', 'è¯·å…ˆé…ç½®GitHubè®¾ç½®å¹¶æµ‹è¯•è¿æ¥');
                addLog('âŒ GitHubè®¾ç½®ä¸å®Œæ•´');
                return;
            }

            addLog('âœ… GitHubè®¾ç½®æ£€æŸ¥é€šè¿‡');

            try {
                // è¯»å–æœ¬åœ°å­˜å‚¨ä¸­çš„ä½¿ç”¨è®°å½•
                let localUsedCodes = [];
                try {
                    const stored = localStorage.getItem('usedCodes');
                    addLog(`ğŸ“– è¯»å–localStorage: ${stored ? 'æ‰¾åˆ°æ•°æ®' : 'æ— æ•°æ®'}`);

                    if (stored) {
                        localUsedCodes = JSON.parse(stored);
                        addLog(`âœ… è§£ææˆåŠŸï¼Œæ‰¾åˆ° ${localUsedCodes.length} æ¡è®°å½•`);
                    } else {
                        addLog('âš ï¸ localStorageä¸­æ²¡æœ‰usedCodesæ•°æ®');
                    }
                } catch (error) {
                    addLog(`âŒ è¯»å–localStorageå¤±è´¥: ${error.message}`);
                }

                if (localUsedCodes.length === 0) {
                    showResult('info', 'æœ¬åœ°æ²¡æœ‰ä½¿ç”¨è®°å½•éœ€è¦åŒæ­¥');
                    addLog('â„¹ï¸ æœ¬åœ°æ²¡æœ‰ä½¿ç”¨è®°å½•éœ€è¦åŒæ­¥');
                    return;
                }

                // è·å–GitHubä¸Šçš„å½“å‰ä½¿ç”¨è®°å½•
                const url = `https://api.github.com/repos/${githubSettings.username}/${githubSettings.repo}/contents/used-codes.json`;
                let sha = '';
                let currentData = { usedCodes: [] };

                try {
                    const response = await fetch(url, {
                        headers: {
                            'Authorization': `token ${githubSettings.token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        currentData = JSON.parse(atob(data.content));
                        sha = data.sha;
                        addLog(`ğŸ“¥ å·²è·å–GitHubä¸Šçš„ä½¿ç”¨è®°å½•ï¼š${currentData.usedCodes.length} æ¡`);
                    }
                } catch (error) {
                    addLog('âš ï¸ GitHubä¸Šæ²¡æœ‰ä½¿ç”¨è®°å½•æ–‡ä»¶ï¼Œå°†åˆ›å»ºæ–°æ–‡ä»¶');
                }

                // åˆå¹¶æœ¬åœ°å’ŒæœåŠ¡å™¨è®°å½•
                const existingCodes = new Set(currentData.usedCodes.map(record => record.code));
                const newRecords = localUsedCodes.filter(record => !existingCodes.has(record.code));

                if (newRecords.length === 0) {
                    showResult('info', 'æ‰€æœ‰ä½¿ç”¨è®°å½•å·²åŒæ­¥ï¼Œæ— éœ€æ›´æ–°');
                    addLog('âœ… æ‰€æœ‰ä½¿ç”¨è®°å½•å·²åŒæ­¥');
                    return;
                }

                // æ·»åŠ æ–°è®°å½•
                currentData.usedCodes.push(...newRecords);
                currentData.lastUpdated = new Date().toISOString();

                // ä¸Šä¼ åˆ°GitHub
                const content = btoa(JSON.stringify(currentData, null, 2));
                const uploadData = {
                    message: `åŒæ­¥ ${newRecords.length} æ¡ä½¿ç”¨è®°å½•`,
                    content: content
                };

                if (sha) {
                    uploadData.sha = sha;
                }

                addLog(`ğŸ“¤ å‡†å¤‡ä¸Šä¼  ${newRecords.length} æ¡æ–°è®°å½•åˆ°GitHub...`);

                const uploadResponse = await fetch(url, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${githubSettings.token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(uploadData)
                });

                if (uploadResponse.ok) {
                    const result = await uploadResponse.json();
                    showResult('success', `æˆåŠŸåŒæ­¥ ${newRecords.length} æ¡ä½¿ç”¨è®°å½•åˆ°GitHub`);
                    addLog(`ğŸ‰ æˆåŠŸåŒæ­¥ ${newRecords.length} æ¡ä½¿ç”¨è®°å½•`);
                    addLog(`ğŸ”— æäº¤è®°å½•ï¼š${result.commit.html_url}`);
                } else {
                    const errorData = await uploadResponse.json();
                    throw new Error(`GitHub APIé”™è¯¯: ${errorData.message}`);
                }

            } catch (error) {
                showResult('error', `åŒæ­¥å¤±è´¥ï¼š${error.message}`);
                addLog(`âŒ åŒæ­¥å¤±è´¥: ${error.message}`);
            }
        }

        // ç”Ÿæˆå…‘æ¢ç å‡½æ•°ï¼ˆç®€åŒ–ç‰ˆï¼‰
        function generateAndUploadCodes() {
            addLog('ğŸš€ å¼€å§‹ç”Ÿæˆå…‘æ¢ç ...');
            showResult('info', 'ç”ŸæˆåŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­ï¼Œè¯·å…ˆä½¿ç”¨æµ‹è¯•åŠŸèƒ½');
        }

        // æ·»åŠ æ—¥å¿—
        function addLog(message) {
            const logDiv = document.getElementById('operationLog');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `<span class="text-gray-500">[${timestamp}]</span> ${message}`;
            logDiv.appendChild(logEntry);
            logDiv.scrollTop = logDiv.scrollHeight;

            // ä¿æŒæœ€å¤š50æ¡æ—¥å¿—
            while (logDiv.children.length > 50) {
                logDiv.removeChild(logDiv.firstChild);
            }
        }

        // æ¸…ç©ºæ—¥å¿—
        function clearLog() {
            const logDiv = document.getElementById('operationLog');
            logDiv.innerHTML = '<div class="text-gray-500">æ—¥å¿—å·²æ¸…ç©º</div>';
        }

        // æ˜¾ç¤ºç»“æœ
        function showResult(type, message) {
            const resultDiv = document.getElementById('result');
            const resultContent = document.getElementById('resultContent');

            resultDiv.classList.remove('hidden');
            resultContent.innerHTML = `
                <div class="p-3 rounded ${
                    type === 'success'
                        ? 'bg-green-100 text-green-700'
                        : type === 'info'
                        ? 'bg-blue-100 text-blue-700'
                        : 'bg-red-100 text-red-700'
                }">
                    ${message}
                </div>
            `;

            // 3ç§’åè‡ªåŠ¨éšè—
            setTimeout(() => {
                resultDiv.classList.add('hidden');
            }, 3000);
        }
    </script>
</body>
</html>