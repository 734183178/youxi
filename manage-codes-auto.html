<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SCL-90 å…‘æ¢ç ç®¡ç†å·¥å…· - è‡ªåŠ¨æ›´æ–°ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* è‡ªå®šä¹‰æ»šåŠ¨æ¡ */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
    </style>
</head>
<body class="bg-gray-100 p-4 sm:p-8">
    <div class="max-w-6xl mx-auto">
        <!-- å®‰å…¨è­¦å‘Š -->
        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6">
            <h3 class="text-yellow-800 font-semibold mb-2">ğŸ” è‡ªåŠ¨æ›´æ–°åŠŸèƒ½è¯´æ˜</h3>
            <div class="text-yellow-700 text-sm space-y-1">
                <p>â€¢ éœ€è¦æä¾›GitHub Personal Access Tokenç”¨äºè‡ªåŠ¨æ›´æ–°</p>
                <p>â€¢ Tokenåªä¼šä¿å­˜åœ¨æœ¬åœ°æµè§ˆå™¨ï¼Œä¸ä¼šä¸Šä¼ åˆ°æœåŠ¡å™¨</p>
                <p>â€¢ å»ºè®®åˆ›å»ºæœ€å°æƒé™çš„Tokenï¼ˆä»…repoæƒé™ï¼‰</p>
                <p>â€¢ å¦‚æœæ‹…å¿ƒå®‰å…¨ï¼Œå¯ä»¥ç»§ç»­ä½¿ç”¨æ‰‹åŠ¨æ›´æ–°æ¨¡å¼</p>
            </div>
        </div>

        <h1 class="text-2xl sm:text-3xl font-bold mb-6 sm:mb-8 text-center">SCL-90 å…‘æ¢ç ç®¡ç†å·¥å…· (è‡ªåŠ¨æ›´æ–°ç‰ˆ)</h1>

        <!-- GitHubè®¾ç½® -->
        <div class="bg-white rounded-lg shadow-lg p-4 sm:p-6 mb-6">
            <h2 class="text-lg sm:text-xl font-semibold mb-4">GitHub è®¾ç½®</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label class="block text-sm font-medium mb-2">GitHubç”¨æˆ·å</label>
                    <input
                        type="text"
                        id="githubUsername"
                        class="w-full p-2 border rounded"
                        placeholder="your-username"
                    />
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">ä»“åº“åç§°</label>
                    <input
                        type="text"
                        id="githubRepo"
                        class="w-full p-2 border rounded"
                        placeholder="your-repo"
                    />
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Access Token</label>
                    <input
                        type="password"
                        id="githubToken"
                        class="w-full p-2 border rounded"
                        placeholder="ghp_xxxxxxxxxxxx"
                    />
                </div>
            </div>
            <div class="mt-4">
                <button
                    onclick="testGitHubConnection()"
                    class="bg-blue-500 text-white py-2 px-4 rounded hover:bg-blue-600 transition-colors"
                >
                    æµ‹è¯•GitHubè¿æ¥
                </button>
                <button
                    onclick="saveGitHubSettings()"
                    class="ml-2 bg-green-500 text-white py-2 px-4 rounded hover:bg-green-600 transition-colors"
                >
                    ä¿å­˜è®¾ç½®åˆ°æœ¬åœ°
                </button>
            </div>
            <div id="connectionStatus" class="mt-2 text-sm"></div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-6">
            <!-- ç”Ÿæˆå…‘æ¢ç  -->
            <div class="bg-white rounded-lg shadow-lg p-4 sm:p-6">
                <h2 class="text-lg sm:text-xl font-semibold mb-4">æ‰¹é‡ç”Ÿæˆå…‘æ¢ç </h2>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">æ•°é‡</label>
                        <input
                            type="number"
                            id="generateCount"
                            class="w-full p-2 border rounded"
                            value="10"
                            min="1"
                            max="100"
                        />
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">æ‰¹æ¬¡</label>
                        <input
                            type="text"
                            id="batchName"
                            class="w-full p-2 border rounded"
                            value="auto2024"
                        />
                    </div>
                    <div class="bg-blue-50 p-3 rounded">
                        <p class="text-sm text-blue-700">
                            <strong>å…‘æ¢ç æ ¼å¼ï¼š</strong>10ä½å­—æ¯æ•°å­—æ··åˆï¼ˆå¦‚ï¼šA3B7K9M2N8ï¼‰
                        </p>
                        <p class="text-xs text-blue-600 mt-1">
                            ä½¿ç”¨åŠ å¯†å®‰å…¨çš„éšæœºç®—æ³•ï¼Œç¡®ä¿å”¯ä¸€æ€§å’Œå¯è¯»æ€§
                        </p>
                    </div>
                    <button
                        onclick="generateAndUploadCodes()"
                        class="w-full bg-green-500 text-white py-2 px-4 rounded hover:bg-green-600 transition-colors flex items-center justify-center"
                        id="generateButton"
                    >
                        <span id="buttonText">ç”Ÿæˆå¹¶è‡ªåŠ¨ä¸Šä¼ åˆ°GitHub</span>
                        <span id="buttonLoader" class="ml-2 hidden">ğŸ”„</span>
                    </button>
                </div>
            </div>

            <!-- æ‰‹åŠ¨æ·»åŠ å…‘æ¢ç  -->
            <div class="bg-white rounded-lg shadow-lg p-4 sm:p-6">
                <h2 class="text-lg sm:text-xl font-semibold mb-4">æ‰‹åŠ¨æ·»åŠ å…‘æ¢ç </h2>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">å…‘æ¢ç ï¼ˆæ¯è¡Œä¸€ä¸ªï¼‰</label>
                        <textarea
                            id="newCodes"
                            class="w-full p-2 border rounded h-24 sm:h-32"
                            placeholder="LVOE123&#10;TEST456&#10;SCL789"
                        ></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">æ‰¹æ¬¡</label>
                        <input
                            type="text"
                            id="manualBatchName"
                            class="w-full p-2 border rounded"
                            value="manual"
                        />
                    </div>
                    <button
                        onclick="addManualCodesAndUpload()"
                        class="w-full bg-blue-500 text-white py-2 px-4 rounded hover:bg-blue-600 transition-colors"
                    >
                        æ·»åŠ å¹¶è‡ªåŠ¨ä¸Šä¼ åˆ°GitHub
                    </button>
                </div>
            </div>
        </div>

        <!-- å½“å‰å…‘æ¢ç åˆ—è¡¨ -->
        <div class="mt-6 sm:mt-8 bg-white rounded-lg shadow-lg p-4 sm:p-6">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-4">
                <h2 class="text-lg sm:text-xl font-semibold">å½“å‰å…‘æ¢ç åˆ—è¡¨</h2>
                <div class="flex gap-2">
                    <button
                        onclick="loadCurrentCodes()"
                        class="bg-purple-500 text-white py-2 px-4 rounded hover:bg-purple-600 transition-colors"
                    >
                        ä»GitHubåŠ è½½
                    </button>
                    <button
                        onclick="syncUsedCodes()"
                        class="bg-orange-500 text-white py-2 px-4 rounded hover:bg-orange-600 transition-colors"
                    >
                        åŒæ­¥ä½¿ç”¨è®°å½•
                    </button>
                </div>
            </div>
            <div class="mb-4 text-sm text-gray-600">
                æ€»è®¡ï¼š<span id="totalCodes" class="font-semibold">0</span> ä¸ªå…‘æ¢ç  |
                å¯ç”¨ï¼š<span id="availableCodes" class="font-semibold text-green-600">0</span> ä¸ª |
                å·²ç”¨ï¼š<span id="usedCodes" class="font-semibold text-red-600">0</span> ä¸ª
            </div>
            <!-- æ‰¹é‡æ“ä½œå·¥å…·æ  -->
            <div class="mb-4 flex flex-wrap gap-2">
                <button
                    onclick="toggleSelectMode()"
                    class="bg-gray-500 text-white py-2 px-4 rounded hover:bg-gray-600 transition-colors text-sm"
                    id="selectModeButton"
                >
                    â˜‘ï¸ é€‰æ‹©æ¨¡å¼
                </button>
                <button
                    onclick="selectAllCodes()"
                    class="bg-indigo-500 text-white py-2 px-4 rounded hover:bg-indigo-600 transition-colors text-sm hidden"
                    id="selectAllButton"
                >
                    å…¨é€‰
                </button>
                <button
                    onclick="deleteSelectedCodes()"
                    class="bg-red-500 text-white py-2 px-4 rounded hover:bg-red-600 transition-colors text-sm hidden"
                    id="deleteSelectedButton"
                >
                    ğŸ—‘ï¸ åˆ é™¤é€‰ä¸­ (0)
                </button>
                <button
                    onclick="clearSelection()"
                    class="bg-gray-400 text-white py-2 px-4 rounded hover:bg-gray-500 transition-colors text-sm hidden"
                    id="clearSelectionButton"
                >
                    å–æ¶ˆé€‰æ‹©
                </button>
            </div>

            <div class="overflow-x-auto">
                <table class="min-w-full table-auto text-sm">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-2 sm:px-4 py-2 text-left w-8 hidden" id="selectColumn">
                                <input
                                    type="checkbox"
                                    id="selectAllCheckbox"
                                    onchange="toggleSelectAll()"
                                    class="rounded"
                                />
                            </th>
                            <th class="px-2 sm:px-4 py-2 text-left">å…‘æ¢ç </th>
                            <th class="px-2 sm:px-4 py-2 text-left">çŠ¶æ€</th>
                            <th class="px-2 sm:px-4 py-2 text-left">æ‰¹æ¬¡</th>
                            <th class="px-2 sm:px-4 py-2 text-left hidden sm:table-cell">åˆ›å»ºæ—¶é—´</th>
                            <th class="px-2 sm:px-4 py-2 text-left hidden" id="actionColumn">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="codesTable">
                        <tr>
                            <td colspan="5" class="text-center py-4 text-gray-500">
                                ç‚¹å‡»"ä»GitHubåŠ è½½"æˆ–ç”Ÿæˆæ–°å…‘æ¢ç 
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- æ“ä½œæ—¥å¿— -->
        <div class="mt-6 sm:mt-8 bg-white rounded-lg shadow-lg p-4 sm:p-6">
            <h2 class="text-lg sm:text-xl font-semibold mb-4">æ“ä½œæ—¥å¿—</h2>
            <div id="operationLog" class="space-y-2 max-h-40 overflow-y-auto text-sm font-mono">
                <div class="text-gray-500">ç­‰å¾…æ“ä½œ...</div>
            </div>
        </div>

        <!-- ç»“æœæ˜¾ç¤º -->
        <div id="result" class="mt-6 p-4 border rounded-lg hidden">
            <h3 class="font-semibold mb-2">æ“ä½œç»“æœï¼š</h3>
            <div id="resultContent"></div>
        </div>
    </div>

    <script>
        // å½“å‰å…‘æ¢ç åˆ—è¡¨
        let currentCodes = [];
        let githubSettings = {
            username: '',
            repo: '',
            token: ''
        };

        // é€‰æ‹©æ¨¡å¼ç›¸å…³å˜é‡
        let selectMode = false;
        let selectedCodes = new Set();

        // é¡µé¢åŠ è½½æ—¶è¯»å–ä¿å­˜çš„è®¾ç½®
        window.addEventListener('load', () => {
            loadSavedSettings();
            loadCurrentCodes();
        });

        // åŠ è½½ä¿å­˜çš„GitHubè®¾ç½®
        function loadSavedSettings() {
            try {
                const saved = localStorage.getItem('githubSettings');
                if (saved) {
                    githubSettings = JSON.parse(saved);
                    document.getElementById('githubUsername').value = githubSettings.username || '';
                    document.getElementById('githubRepo').value = githubSettings.repo || '';
                    document.getElementById('githubToken').value = githubSettings.token || '';
                }
            } catch (error) {
                console.warn('æ— æ³•è¯»å–ä¿å­˜çš„è®¾ç½®:', error);
            }
        }

        // ä¿å­˜GitHubè®¾ç½®
        function saveGitHubSettings() {
            githubSettings = {
                username: document.getElementById('githubUsername').value.trim(),
                repo: document.getElementById('githubRepo').value.trim(),
                token: document.getElementById('githubToken').value.trim()
            };

            if (!githubSettings.username || !githubSettings.repo || !githubSettings.token) {
                showResult('error', 'è¯·å¡«å†™å®Œæ•´çš„GitHubè®¾ç½®ä¿¡æ¯');
                return;
            }

            try {
                localStorage.setItem('githubSettings', JSON.stringify(githubSettings));
                showResult('success', 'GitHubè®¾ç½®å·²ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨');
                addLog('âœ… GitHubè®¾ç½®å·²ä¿å­˜');
            } catch (error) {
                showResult('error', 'ä¿å­˜è®¾ç½®å¤±è´¥');
            }
        }

        // æµ‹è¯•GitHubè¿æ¥
        async function testGitHubConnection() {
            const username = document.getElementById('githubUsername').value.trim();
            const repo = document.getElementById('githubRepo').value.trim();
            const token = document.getElementById('githubToken').value.trim();

            if (!username || !repo || !token) {
                showConnectionStatus('âŒ è¯·å¡«å†™å®Œæ•´çš„GitHubè®¾ç½®ä¿¡æ¯', 'error');
                return;
            }

            addLog('ğŸ”„ æµ‹è¯•GitHubè¿æ¥...');
            showConnectionStatus('ğŸ”„ æµ‹è¯•ä¸­...', 'info');

            try {
                const response = await fetch(`https://api.github.com/repos/${username}/${repo}`, {
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                if (response.ok) {
                    const repoData = await response.json();
                    showConnectionStatus(`âœ… è¿æ¥æˆåŠŸï¼ä»“åº“ï¼š${repoData.full_name}`, 'success');
                    addLog('âœ… GitHubè¿æ¥æµ‹è¯•æˆåŠŸ');
                } else {
                    showConnectionStatus('âŒ è¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç”¨æˆ·åã€ä»“åº“åå’ŒToken', 'error');
                    addLog(`âŒ GitHubè¿æ¥å¤±è´¥: ${response.status}`);
                }
            } catch (error) {
                showConnectionStatus('âŒ ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥', 'error');
                addLog(`âŒ ç½‘ç»œé”™è¯¯: ${error.message}`);
            }
        }

        // æ˜¾ç¤ºè¿æ¥çŠ¶æ€
        function showConnectionStatus(message, type) {
            const statusDiv = document.getElementById('connectionStatus');
            const colorClass = type === 'success' ? 'text-green-600' : type === 'error' ? 'text-red-600' : 'text-blue-600';
            statusDiv.innerHTML = `<span class="${colorClass}">${message}</span>`;
        }

        // æ·»åŠ æ—¥å¿—
        function addLog(message) {
            const logDiv = document.getElementById('operationLog');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `<span class="text-gray-500">[${timestamp}]</span> ${message}`;
            logDiv.appendChild(logEntry);
            logDiv.scrollTop = logDiv.scrollHeight;

            // ä¿æŒæœ€å¤š20æ¡æ—¥å¿—
            while (logDiv.children.length > 20) {
                logDiv.removeChild(logDiv.firstChild);
            }
        }

        // ç”Ÿæˆå”¯ä¸€å…‘æ¢ç  - 10ä½å­—æ¯æ•°å­—æ··åˆ
        function generateUniqueCode(prefix, index) {
            // ç”Ÿæˆå­—ç¬¦é›†ï¼šå¤§å†™å­—æ¯ + æ•°å­—ï¼ˆæ’é™¤å®¹æ˜“æ··æ·†çš„å­—ç¬¦ï¼š0,O,1,Iï¼‰
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let result = '';

            // ä½¿ç”¨åŠ å¯†å®‰å…¨çš„éšæœºæ•°ç”Ÿæˆå™¨
            const array = new Uint8Array(10);
            crypto.getRandomValues(array);

            for (let i = 0; i < 10; i++) {
                // ç¡®ä¿éšæœºæ•°å‡åŒ€åˆ†å¸ƒ
                const randomIndex = array[i] % chars.length;
                result += chars.charAt(randomIndex);
            }

            return result;
        }

        // ç”Ÿæˆå…‘æ¢ç å¹¶è‡ªåŠ¨ä¸Šä¼ 
        async function generateAndUploadCodes() {
            const count = parseInt(document.getElementById('generateCount').value);
            const batch = document.getElementById('batchName').value.trim();

            // éªŒè¯è¾“å…¥
            if (!githubSettings.username || !githubSettings.repo || !githubSettings.token) {
                showResult('error', 'è¯·å…ˆé…ç½®GitHubè®¾ç½®å¹¶æµ‹è¯•è¿æ¥');
                return;
            }

            if (count < 1 || count > 100) {
                showResult('error', 'æ•°é‡å¿…é¡»åœ¨1-100ä¹‹é—´');
                return;
            }

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const button = document.getElementById('generateButton');
            const buttonText = document.getElementById('buttonText');
            const buttonLoader = document.getElementById('buttonLoader');

            button.disabled = true;
            buttonText.textContent = 'ç”Ÿæˆä¸­...';
            buttonLoader.classList.remove('hidden');

            addLog(`ğŸ”„ å¼€å§‹ç”Ÿæˆ ${count} ä¸ªå…‘æ¢ç ...`);

            try {
                // è·å–ç°æœ‰å…‘æ¢ç ç”¨äºé‡å¤æ£€æµ‹
                const currentData = await getCurrentCodesFromGitHub();
                const existingCodes = new Set(currentData.codes.map(c => c.code));

                // ç”Ÿæˆæ–°å…‘æ¢ç ï¼ˆç¡®ä¿å”¯ä¸€æ€§ï¼‰
                const newCodes = [];
                let attempts = 0;
                const maxAttempts = count * 10; // æœ€å¤šå°è¯•10å€æ•°é‡

                while (newCodes.length < count && attempts < maxAttempts) {
                    const newCode = generateUniqueCode();

                    // æ£€æŸ¥æ˜¯å¦ä¸ç°æœ‰ç é‡å¤
                    if (!existingCodes.has(newCode) && !newCodes.some(c => c.code === newCode)) {
                        newCodes.push({
                            code: newCode,
                            status: 'available',
                            createdAt: new Date().toISOString(),
                            batch: batch
                        });
                    }
                    attempts++;
                }

                if (newCodes.length < count) {
                    showResult('error', `åªç”Ÿæˆäº† ${newCodes.length} ä¸ªå”¯ä¸€å…‘æ¢ç ï¼Œæœªè¾¾åˆ°ç›®æ ‡æ•°é‡ ${count}`);
                    return;
                }

                addLog(`âœ… å·²ç”Ÿæˆ ${newCodes.length} ä¸ªå”¯ä¸€å…‘æ¢ç `);

                // åˆå¹¶æ•°æ®
                const allCodes = [...currentData.codes, ...newCodes];

                // æ›´æ–°æ•°æ®
                const updateData = {
                    codes: allCodes,
                    lastUpdated: new Date().toISOString(),
                    version: "1.0"
                };

                // ä¸Šä¼ åˆ°GitHub
                buttonText.textContent = 'ä¸Šä¼ åˆ°GitHub...';
                addLog('ğŸ”„ ä¸Šä¼ æ–°æ•°æ®åˆ°GitHub...');

                await uploadCodesToGitHub(updateData);

                // æ›´æ–°æœ¬åœ°æ˜¾ç¤º
                currentCodes = allCodes;
                displayCodes();

                showResult('success', `æˆåŠŸç”Ÿæˆå¹¶ä¸Šä¼  ${count} ä¸ªå…‘æ¢ç åˆ°GitHub`);
                addLog(`ğŸ‰ æˆåŠŸå®Œæˆï¼æ€»å…± ${allCodes.length} ä¸ªå…‘æ¢ç `);

            } catch (error) {
                showResult('error', `æ“ä½œå¤±è´¥ï¼š${error.message}`);
                addLog(`âŒ æ“ä½œå¤±è´¥: ${error.message}`);
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                button.disabled = false;
                buttonText.textContent = 'ç”Ÿæˆå¹¶è‡ªåŠ¨ä¸Šä¼ åˆ°GitHub';
                buttonLoader.classList.add('hidden');
            }
        }

        // æ‰‹åŠ¨æ·»åŠ å…‘æ¢ç å¹¶ä¸Šä¼ 
        async function addManualCodesAndUpload() {
            const codesText = document.getElementById('newCodes').value.trim();
            const batch = document.getElementById('manualBatchName').value.trim();

            if (!githubSettings.username || !githubSettings.repo || !githubSettings.token) {
                showResult('error', 'è¯·å…ˆé…ç½®GitHubè®¾ç½®å¹¶æµ‹è¯•è¿æ¥');
                return;
            }

            if (!codesText) {
                showResult('error', 'è¯·è¾“å…¥å…‘æ¢ç ');
                return;
            }

            try {
                const codes = codesText.split('\n')
                    .map(code => code.trim().toUpperCase())
                    .filter(code => code.length > 0);

                if (codes.length === 0) {
                    showResult('error', 'æ²¡æœ‰æœ‰æ•ˆçš„å…‘æ¢ç ');
                    return;
                }

                addLog(`ğŸ”„ å¤„ç† ${codes.length} ä¸ªæ‰‹åŠ¨å…‘æ¢ç ...`);

                // è·å–å½“å‰æ•°æ®
                const currentData = await getCurrentCodesFromGitHub();

                // æ£€æŸ¥é‡å¤
                const duplicates = codes.filter(code =>
                    currentData.codes.some(existing => existing.code === code)
                );

                if (duplicates.length > 0) {
                    showResult('error', `ä»¥ä¸‹å…‘æ¢ç å·²å­˜åœ¨ï¼š${duplicates.join(', ')}`);
                    return;
                }

                // åˆ›å»ºæ–°å…‘æ¢ç 
                const newCodes = codes.map(code => ({
                    code: code,
                    status: 'available',
                    createdAt: new Date().toISOString(),
                    batch: batch
                }));

                // åˆå¹¶æ•°æ®
                const allCodes = [...currentData.codes, ...newCodes];
                const updateData = {
                    codes: allCodes,
                    lastUpdated: new Date().toISOString(),
                    version: "1.0"
                };

                // ä¸Šä¼ åˆ°GitHub
                await uploadCodesToGitHub(updateData);

                // æ›´æ–°æœ¬åœ°æ˜¾ç¤º
                currentCodes = allCodes;
                displayCodes();

                showResult('success', `æˆåŠŸæ·»åŠ å¹¶ä¸Šä¼  ${codes.length} ä¸ªå…‘æ¢ç `);
                addLog(`ğŸ‰ æˆåŠŸæ·»åŠ  ${codes.length} ä¸ªå…‘æ¢ç `);
                document.getElementById('newCodes').value = '';

            } catch (error) {
                showResult('error', `æ“ä½œå¤±è´¥ï¼š${error.message}`);
                addLog(`âŒ æ“ä½œå¤±è´¥: ${error.message}`);
            }
        }

        // ä»GitHubè·å–å½“å‰å…‘æ¢ç 
        async function getCurrentCodesFromGitHub() {
            try {
                const url = `https://api.github.com/repos/${githubSettings.username}/${githubSettings.repo}/contents/codes.json`;
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `token ${githubSettings.token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    const content = atob(data.content);
                    return JSON.parse(content);
                } else if (response.status === 404) {
                    // æ–‡ä»¶ä¸å­˜åœ¨ï¼Œè¿”å›ç©ºæ•°æ®
                    return { codes: [], lastUpdated: new Date().toISOString(), version: "1.0" };
                } else {
                    throw new Error(`GitHub APIé”™è¯¯: ${response.status}`);
                }
            } catch (error) {
                throw new Error(`è·å–GitHubæ•°æ®å¤±è´¥: ${error.message}`);
            }
        }

        // ä¸Šä¼ å…‘æ¢ç åˆ°GitHub
        async function uploadCodesToGitHub(data) {
            try {
                const url = `https://api.github.com/repos/${githubSettings.username}/${githubSettings.repo}/contents/codes.json`;

                // å…ˆè·å–å½“å‰æ–‡ä»¶çš„SHAï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                let sha = '';
                try {
                    const getCurrentResponse = await fetch(url, {
                        headers: {
                            'Authorization': `token ${githubSettings.token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });
                    if (getCurrentResponse.ok) {
                        const currentData = await getCurrentResponse.json();
                        sha = currentData.sha;
                    }
                } catch (error) {
                    // æ–‡ä»¶ä¸å­˜åœ¨ï¼ŒSHAä¿æŒä¸ºç©º
                }

                // å‡†å¤‡ä¸Šä¼ æ•°æ®
                const content = btoa(JSON.stringify(data, null, 2));
                const uploadData = {
                    message: `æ·»åŠ  ${data.codes.length} ä¸ªå…‘æ¢ç  - ${new Date().toLocaleString()}`,
                    content: content
                };

                if (sha) {
                    uploadData.sha = sha;
                }

                const response = await fetch(url, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${githubSettings.token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(uploadData)
                });

                if (response.ok) {
                    const result = await response.json();
                    addLog(`âœ… GitHubæ›´æ–°æˆåŠŸ: ${result.commit.html_url}`);
                    return result;
                } else {
                    const errorData = await response.json();
                    throw new Error(`GitHub APIé”™è¯¯: ${errorData.message}`);
                }
            } catch (error) {
                throw new Error(`ä¸Šä¼ åˆ°GitHubå¤±è´¥: ${error.message}`);
            }
        }

        // ä»GitHubåŠ è½½å½“å‰å…‘æ¢ç 
        async function loadCurrentCodes() {
            if (!githubSettings.username || !githubSettings.repo || !githubSettings.token) {
                showResult('error', 'è¯·å…ˆé…ç½®GitHubè®¾ç½®');
                return;
            }

            addLog('ğŸ”„ ä»GitHubåŠ è½½å…‘æ¢ç ...');

            try {
                const data = await getCurrentCodesFromGitHub();
                currentCodes = data.codes || [];
                displayCodes();
                showResult('success', `å·²ä»GitHubåŠ è½½ ${currentCodes.length} ä¸ªå…‘æ¢ç `);
                addLog(`âœ… æˆåŠŸåŠ è½½ ${currentCodes.length} ä¸ªå…‘æ¢ç `);
            } catch (error) {
                showResult('error', `åŠ è½½å¤±è´¥ï¼š${error.message}`);
                addLog(`âŒ åŠ è½½å¤±è´¥: ${error.message}`);
            }
        }

        // æ˜¾ç¤ºå…‘æ¢ç è¡¨æ ¼
        function displayCodes() {
            const table = document.getElementById('codesTable');

            // ç»Ÿè®¡ä¿¡æ¯
            const totalCount = currentCodes.length;
            const availableCount = currentCodes.filter(c => c.status === 'available').length;
            const usedCount = currentCodes.filter(c => c.status === 'used').length;

            document.getElementById('totalCodes').textContent = totalCount;
            document.getElementById('availableCodes').textContent = availableCount;
            document.getElementById('usedCodes').textContent = usedCount;

            if (currentCodes.length > 0) {
                table.innerHTML = currentCodes.map((code, index) => {
                    const isSelected = selectedCodes.has(code.code);
                    return `
                        <tr class="border-b ${isSelected ? 'bg-blue-50' : ''} ${selectMode ? 'hover:bg-gray-50' : ''}">
                            ${selectMode ? `
                                <td class="px-2 sm:px-4 py-2">
                                    <input
                                        type="checkbox"
                                        ${isSelected ? 'checked' : ''}
                                        onchange="toggleCodeSelection('${code.code}')"
                                        class="rounded"
                                    />
                                </td>
                            ` : ''}
                            <td class="px-2 sm:px-4 py-2 font-mono text-xs sm:text-sm">${code.code}</td>
                            <td class="px-2 sm:px-4 py-2">
                                <span class="px-2 py-1 rounded text-xs ${
                                    code.status === 'available'
                                        ? 'bg-green-100 text-green-700'
                                        : 'bg-red-100 text-red-700'
                                }">
                                    ${code.status === 'available' ? 'å¯ç”¨' : 'å·²ç”¨'}
                                </span>
                            </td>
                            <td class="px-2 sm:px-4 py-2 text-xs sm:text-sm">${code.batch}</td>
                            <td class="px-2 sm:px-4 py-2 text-xs sm:text-sm hidden sm:table-cell">
                                ${new Date(code.createdAt).toLocaleDateString()}
                            </td>
                            ${!selectMode ? `
                                <td class="px-2 sm:px-4 py-2">
                                    <button
                                        onclick="deleteSingleCode('${code.code}')"
                                        class="text-red-500 hover:text-red-700 text-xs sm:text-sm"
                                        title="åˆ é™¤æ­¤å…‘æ¢ç "
                                    >
                                        ğŸ—‘ï¸
                                    </button>
                                </td>
                            ` : ''}
                        </tr>
                    `;
                }).join('');
            } else {
                const colSpan = selectMode ? 6 : 5;
                table.innerHTML = `<tr><td colspan="${colSpan}" class="text-center py-4 text-gray-500">æš‚æ— å…‘æ¢ç </td></tr>`;
            }
        }

        // é€‰æ‹©æ¨¡å¼ç›¸å…³å‡½æ•°
        function toggleSelectMode() {
            selectMode = !selectMode;
            selectedCodes.clear();

            // æ˜¾ç¤º/éšè—ç›¸å…³UIå…ƒç´ 
            document.getElementById('selectColumn').classList.toggle('hidden', !selectMode);
            document.getElementById('actionColumn').classList.toggle('hidden', selectMode);
            document.getElementById('selectAllButton').classList.toggle('hidden', !selectMode);
            document.getElementById('deleteSelectedButton').classList.toggle('hidden', !selectMode);
            document.getElementById('clearSelectionButton').classList.toggle('hidden', !selectMode);

            // æ›´æ–°æŒ‰é’®æ–‡æœ¬
            const selectModeButton = document.getElementById('selectModeButton');
            selectModeButton.innerHTML = selectMode ? 'âŒ é€€å‡ºé€‰æ‹©' : 'â˜‘ï¸ é€‰æ‹©æ¨¡å¼';

            // é‡ç½®å…¨é€‰å¤é€‰æ¡†
            document.getElementById('selectAllCheckbox').checked = false;
            updateDeleteButton();
            displayCodes();

            addLog(selectMode ? 'ğŸ”„ è¿›å…¥é€‰æ‹©æ¨¡å¼' : 'ğŸ”„ é€€å‡ºé€‰æ‹©æ¨¡å¼');
        }

        function toggleSelectAll() {
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            if (selectAllCheckbox.checked) {
                selectAllCodes();
            } else {
                clearSelection();
            }
        }

        function selectAllCodes() {
            selectedCodes.clear();
            currentCodes.forEach(code => selectedCodes.add(code.code));
            document.getElementById('selectAllCheckbox').checked = true;
            updateDeleteButton();
            displayCodes();
            addLog(`âœ… å·²é€‰æ‹©æ‰€æœ‰ ${selectedCodes.size} ä¸ªå…‘æ¢ç `);
        }

        function clearSelection() {
            selectedCodes.clear();
            document.getElementById('selectAllCheckbox').checked = false;
            updateDeleteButton();
            displayCodes();
            addLog('ğŸ”„ å·²æ¸…é™¤æ‰€æœ‰é€‰æ‹©');
        }

        function toggleCodeSelection(code) {
            if (selectedCodes.has(code)) {
                selectedCodes.delete(code);
            } else {
                selectedCodes.add(code);
            }
            updateDeleteButton();
            displayCodes();
        }

        function updateDeleteButton() {
            const deleteButton = document.getElementById('deleteSelectedButton');
            const count = selectedCodes.size;
            deleteButton.innerHTML = `ğŸ—‘ï¸ åˆ é™¤é€‰ä¸­ (${count})`;
            deleteButton.disabled = count === 0;
            deleteButton.className = count === 0
                ? 'bg-gray-300 text-gray-500 py-2 px-4 rounded text-sm cursor-not-allowed'
                : 'bg-red-500 text-white py-2 px-4 rounded hover:bg-red-600 transition-colors text-sm';

            // æ›´æ–°å…¨é€‰å¤é€‰æ¡†çŠ¶æ€
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            if (currentCodes.length > 0) {
                selectAllCheckbox.checked = selectedCodes.size === currentCodes.length;
                selectAllCheckbox.indeterminate = selectedCodes.size > 0 && selectedCodes.size < currentCodes.length;
            }
        }

        // åˆ é™¤å•ä¸ªå…‘æ¢ç 
        async function deleteSingleCode(code) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤å…‘æ¢ç  "${code}" å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼`)) {
                return;
            }

            await deleteCodesFromGitHub([code]);
        }

        // åˆ é™¤é€‰ä¸­çš„å…‘æ¢ç 
        async function deleteSelectedCodes() {
            const codesToDelete = Array.from(selectedCodes);

            if (codesToDelete.length === 0) {
                showResult('error', 'è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„å…‘æ¢ç ');
                return;
            }

            const confirmMessage = `ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${codesToDelete.length} ä¸ªå…‘æ¢ç å—ï¼Ÿ\n\nå…‘æ¢ç åˆ—è¡¨ï¼š\n${codesToDelete.join('\n')}\n\næ­¤æ“ä½œä¸å¯æ’¤é”€ï¼`;

            if (!confirm(confirmMessage)) {
                return;
            }

            await deleteCodesFromGitHub(codesToDelete);
        }

        // ä»GitHubåˆ é™¤å…‘æ¢ç 
        async function deleteCodesFromGitHub(codesToDelete) {
            if (!githubSettings.username || !githubSettings.repo || !githubSettings.token) {
                showResult('error', 'è¯·å…ˆé…ç½®GitHubè®¾ç½®');
                return;
            }

            addLog(`ğŸ”„ å¼€å§‹åˆ é™¤ ${codesToDelete.length} ä¸ªå…‘æ¢ç ...`);

            try {
                // è·å–å½“å‰æ•°æ®
                const currentData = await getCurrentCodesFromGitHub();

                // è¿‡æ»¤æ‰è¦åˆ é™¤çš„å…‘æ¢ç 
                const remainingCodes = currentData.codes.filter(code => !codesToDelete.includes(code.code));

                // æ£€æŸ¥æ˜¯å¦æœ‰å…‘æ¢ç è¢«åˆ é™¤
                if (remainingCodes.length === currentData.codes.length) {
                    showResult('error', 'æ²¡æœ‰æ‰¾åˆ°è¦åˆ é™¤çš„å…‘æ¢ç ');
                    return;
                }

                // æ›´æ–°æ•°æ®
                const updateData = {
                    codes: remainingCodes,
                    lastUpdated: new Date().toISOString(),
                    version: "1.0"
                };

                // ä¸Šä¼ åˆ°GitHub
                await uploadCodesToGitHub(updateData);

                // æ›´æ–°æœ¬åœ°æ•°æ®
                currentCodes = remainingCodes;
                selectedCodes.clear();

                // é€€å‡ºé€‰æ‹©æ¨¡å¼
                if (selectMode) {
                    toggleSelectMode();
                }

                displayCodes();
                showResult('success', `æˆåŠŸåˆ é™¤ ${codesToDelete.length} ä¸ªå…‘æ¢ç `);
                addLog(`ğŸ‰ æˆåŠŸåˆ é™¤ ${codesToDelete.length} ä¸ªå…‘æ¢ç `);
                addLog(`ğŸ“Š å‰©ä½™å…‘æ¢ç ï¼š${remainingCodes.length} ä¸ª`);

            } catch (error) {
                showResult('error', `åˆ é™¤å¤±è´¥ï¼š${error.message}`);
                addLog(`âŒ åˆ é™¤å¤±è´¥: ${error.message}`);
            }
        }

        // åŒæ­¥ä½¿ç”¨è®°å½•
        async function syncUsedCodes() {
            if (!githubSettings.username || !githubSettings.repo || !githubSettings.token) {
                showResult('error', 'è¯·å…ˆé…ç½®GitHubè®¾ç½®');
                return;
            }

            addLog('ğŸ”„ å¼€å§‹åŒæ­¥ä½¿ç”¨è®°å½•...');

            try {
                // è¯»å–æœ¬åœ°å­˜å‚¨ä¸­çš„ä½¿ç”¨è®°å½•
                let localUsedCodes = [];
                try {
                    const stored = localStorage.getItem('usedCodes');
                    if (stored) {
                        localUsedCodes = JSON.parse(stored);
                    }
                } catch (error) {
                    console.warn('æ— æ³•è¯»å–æœ¬åœ°ä½¿ç”¨è®°å½•:', error);
                }

                if (localUsedCodes.length === 0) {
                    showResult('info', 'æœ¬åœ°æ²¡æœ‰ä½¿ç”¨è®°å½•éœ€è¦åŒæ­¥');
                    addLog('â„¹ï¸ æœ¬åœ°æ²¡æœ‰ä½¿ç”¨è®°å½•éœ€è¦åŒæ­¥');
                    return;
                }

                // è·å–GitHubä¸Šçš„å½“å‰ä½¿ç”¨è®°å½•
                const url = `https://api.github.com/repos/${githubSettings.username}/${githubSettings.repo}/contents/used-codes.json`;
                let sha = '';
                let currentData = { usedCodes: [] };

                try {
                    const response = await fetch(url, {
                        headers: {
                            'Authorization': `token ${githubSettings.token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        currentData = JSON.parse(atob(data.content));
                        sha = data.sha;
                        addLog(`ğŸ“¥ å·²è·å–GitHubä¸Šçš„ä½¿ç”¨è®°å½•ï¼š${currentData.usedCodes.length} æ¡`);
                    }
                } catch (error) {
                    addLog('âš ï¸ GitHubä¸Šæ²¡æœ‰ä½¿ç”¨è®°å½•æ–‡ä»¶ï¼Œå°†åˆ›å»ºæ–°æ–‡ä»¶');
                }

                // åˆå¹¶æœ¬åœ°å’ŒæœåŠ¡å™¨è®°å½•
                const existingCodes = new Set(currentData.usedCodes.map(record => record.code));
                const newRecords = localUsedCodes.filter(record => !existingCodes.has(record.code));

                if (newRecords.length === 0) {
                    showResult('info', 'æ‰€æœ‰ä½¿ç”¨è®°å½•å·²åŒæ­¥ï¼Œæ— éœ€æ›´æ–°');
                    addLog('âœ… æ‰€æœ‰ä½¿ç”¨è®°å½•å·²åŒæ­¥');
                    return;
                }

                // æ·»åŠ æ–°è®°å½•
                currentData.usedCodes.push(...newRecords);
                currentData.lastUpdated = new Date().toISOString();

                // ä¸Šä¼ åˆ°GitHub
                const content = btoa(JSON.stringify(currentData, null, 2));
                const uploadData = {
                    message: `åŒæ­¥ ${newRecords.length} æ¡ä½¿ç”¨è®°å½•`,
                    content: content
                };

                if (sha) {
                    uploadData.sha = sha;
                }

                const uploadResponse = await fetch(url, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${githubSettings.token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(uploadData)
                });

                if (uploadResponse.ok) {
                    const result = await uploadResponse.json();
                    showResult('success', `æˆåŠŸåŒæ­¥ ${newRecords.length} æ¡ä½¿ç”¨è®°å½•åˆ°GitHub`);
                    addLog(`ğŸ‰ æˆåŠŸåŒæ­¥ ${newRecords.length} æ¡ä½¿ç”¨è®°å½•`);
                    addLog(`ğŸ”— æäº¤è®°å½•ï¼š${result.commit.html_url}`);
                } else {
                    const errorData = await uploadResponse.json();
                    throw new Error(`GitHub APIé”™è¯¯: ${errorData.message}`);
                }

            } catch (error) {
                showResult('error', `åŒæ­¥å¤±è´¥ï¼š${error.message}`);
                addLog(`âŒ åŒæ­¥å¤±è´¥: ${error.message}`);
            }
        }

        // æ˜¾ç¤ºç»“æœ
        function showResult(type, message) {
            const resultDiv = document.getElementById('result');
            const resultContent = document.getElementById('resultContent');

            resultDiv.classList.remove('hidden');
            resultContent.innerHTML = `
                <div class="p-3 rounded ${
                    type === 'success'
                        ? 'bg-green-100 text-green-700'
                        : type === 'info'
                        ? 'bg-blue-100 text-blue-700'
                        : 'bg-red-100 text-red-700'
                }">
                    ${message}
                </div>
            `;

            // 3ç§’åè‡ªåŠ¨éšè—
            setTimeout(() => {
                resultDiv.classList.add('hidden');
            }, 5000);
        }
    </script>
</body>
</html>