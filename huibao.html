<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½è¯¢ç›˜æ•°æ®æŠ¥å‘Šç”Ÿæˆå™¨</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .header h1 {
            color: #d32f2f;
            font-size: 36px;
            margin-bottom: 10px;
        }
        
        .header p {
            color: #666;
            font-size: 18px;
        }
        
        .upload-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .upload-title {
            color: #d32f2f;
            font-size: 24px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
        }
        
        .upload-title::before {
            content: "ğŸ“Š";
            margin-right: 10px;
        }
        
        .upload-area {
            border: 3px dashed #ddd;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            background: #fafafa;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .upload-area:hover {
            border-color: #d32f2f;
            background: #fff5f5;
        }
        
        .upload-area.dragover {
            border-color: #d32f2f;
            background: #fff5f5;
            transform: scale(1.02);
        }
        
        .upload-icon {
            font-size: 48px;
            margin-bottom: 20px;
        }
        
        .upload-text {
            font-size: 18px;
            color: #666;
            margin-bottom: 10px;
        }
        
        .upload-hint {
            font-size: 14px;
            color: #999;
        }
        
        .file-input {
            display: none;
        }
        
        .settings-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .setting-group {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #d32f2f;
        }
        
        .setting-label {
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
            display: block;
        }
        
        .setting-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }
        
        .setting-input:focus {
            outline: none;
            border-color: #d32f2f;
        }
        
        .generate-btn {
            background: linear-gradient(135deg, #d32f2f, #b71c1c);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: block;
            margin: 30px auto;
            min-width: 200px;
        }
        
        .generate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(211, 47, 47, 0.3);
        }
        
        .generate-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .preview-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            display: none;
        }
        
        .data-preview {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        
        .preview-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .preview-table th,
        .preview-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        .preview-table th {
            background: #f8f9fa;
            font-weight: bold;
            color: #333;
            position: sticky;
            top: 0;
        }
        
        .preview-table tr:hover {
            background: #f5f5f5;
        }
        
        .report-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow: hidden;
            display: none;
            margin-bottom: 20px;
        }
        
        .report-header {
            background: #d32f2f;
            color: white;
            text-align: center;
            padding: 40px 20px;
        }
        
        .report-header h1 {
            font-size: 48px;
            margin: 0;
            font-weight: bold;
        }
        
        .report-header .subtitle {
            font-size: 24px;
            margin: 10px 0 0 0;
            color: #ffcdd2;
        }
        
        .report-content {
            padding: 30px;
        }
        
        .section {
            margin-bottom: 40px;
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            border-left: 5px solid #d32f2f;
        }
        
        .section-title {
            color: #d32f2f;
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
        }
        
        .section-title::before {
            content: "â–¶";
            margin-right: 10px;
            font-size: 20px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            align-items: center;
        }
        
        .stats-text {
            font-size: 16px;
            line-height: 1.8;
        }
        
        .highlight-number {
            color: #d32f2f;
            font-size: 32px;
            font-weight: bold;
        }
        
        .chart-container {
            position: relative;
            width: 300px;
            height: 300px;
            margin: 0 auto;
        }
        
        .pie-chart {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            position: relative;
        }
        
        .chart-legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }
        
        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 3px;
        }
        
        .summary-box {
            background: linear-gradient(135deg, #fff3e0, #ffcc02);
            border: 2px solid #ff9800;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .summary-title {
            font-size: 20px;
            font-weight: bold;
            color: #e65100;
            margin-bottom: 15px;
        }
        
        .key-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .metric-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }
        
        .metric-value {
            font-size: 28px;
            font-weight: bold;
            color: #d32f2f;
            margin-bottom: 5px;
        }
        
        .metric-label {
            font-size: 14px;
            color: #666;
        }
        
        .download-controls {
            text-align: center;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 15px;
            margin: 20px 0;
            display: none;
        }
        
        .download-btn {
            background: #4caf50;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin: 0 10px;
            transition: all 0.3s ease;
        }
        
        .download-btn:hover {
            background: #45a049;
            transform: translateY(-2px);
        }
        
        .progress-bar {
            width: 100%;
            height: 6px;
            background: #f0f0f0;
            border-radius: 3px;
            margin: 10px 0;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #d32f2f, #ff5722);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .status-message {
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            text-align: center;
        }
        
        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- å¤´éƒ¨ -->
        <div class="header">
            <h1>ğŸš€ æ™ºèƒ½è¯¢ç›˜æ•°æ®æŠ¥å‘Šç”Ÿæˆå™¨</h1>
            <p>ä¸Šä¼ å®¢æˆ·æ•°æ®ï¼Œä¸€é”®ç”Ÿæˆä¸“ä¸šæœˆåº¦æŠ¥å‘Š</p>
        </div>
        
        <!-- æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ -->
        <div class="upload-section">
            <h2 class="upload-title">æ•°æ®ä¸Šä¼ </h2>
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">ğŸ“</div>
                <div class="upload-text">ç‚¹å‡»é€‰æ‹©æ–‡ä»¶æˆ–æ‹–æ‹½åˆ°æ­¤å¤„</div>
                <div class="upload-hint">æ”¯æŒ Excel (.xlsx/.xls) å’Œ CSV æ ¼å¼</div>
                <input type="file" class="file-input" id="fileInput" accept=".xlsx,.xls,.csv">
            </div>
            <div id="fileStatus" class="status-message" style="display: none;"></div>
        </div>
        
        <!-- è®¾ç½®åŒºåŸŸ -->
        <div class="settings-section">
            <h2 class="upload-title">æŠ¥å‘Šè®¾ç½®</h2>
            <div class="settings-grid">
                <div class="setting-group">
                    <label class="setting-label">æŠ¥å‘Šæœˆä»½</label>
                    <input type="month" class="setting-input" id="reportMonth" value="">
                </div>
                <div class="setting-group">
                    <label class="setting-label">å…¬å¸åç§°</label>
                    <input type="text" class="setting-input" id="companyName" placeholder="è¯·è¾“å…¥å…¬å¸åç§°" value="è´µå…¬å¸">
                </div>
                <div class="setting-group">
                    <label class="setting-label">æŠ¥å‘Šç±»å‹</label>
                    <select class="setting-input" id="reportType">
                        <option value="both">å¤–è´¸ + å†…è´¸</option>
                        <option value="foreign">ä»…å¤–è´¸</option>
                        <option value="domestic">ä»…å†…è´¸</option>
                    </select>
                </div>
                <div class="setting-group">
                    <label class="setting-label">ä¸ä¸Šæœˆå¯¹æ¯”</label>
                    <select class="setting-input" id="compareMode">
                        <option value="auto">è‡ªåŠ¨è®¡ç®—</option>
                        <option value="manual">æ‰‹åŠ¨è¾“å…¥</option>
                        <option value="none">ä¸æ˜¾ç¤ºå¯¹æ¯”</option>
                    </select>
                </div>
            </div>
        </div>
        
        <!-- æ•°æ®é¢„è§ˆåŒºåŸŸ -->
        <div class="preview-section" id="previewSection">
            <h2 class="upload-title">æ•°æ®é¢„è§ˆ</h2>
            <div class="data-preview" id="dataPreview"></div>
        </div>
        
        <!-- ç”ŸæˆæŒ‰é’® -->
        <button class="generate-btn" id="generateBtn" disabled>
            ğŸ“Š ç”ŸæˆæŠ¥å‘Š
        </button>
        
        <!-- è¿›åº¦æ¡ -->
        <div class="progress-bar" id="progressBar" style="display: none;">
            <div class="progress-fill" id="progressFill"></div>
        </div>
        
        <!-- ä¸‹è½½æ§åˆ¶ -->
        <div class="download-controls" id="downloadControls">
            <h3>ğŸ“¥ ä¸‹è½½æŠ¥å‘Š</h3>
            <button class="download-btn" onclick="downloadAsPNG()">ä¸‹è½½ PNG å›¾ç‰‡</button>
            <button class="download-btn" onclick="downloadAsPDF()" style="background: #ff5722;">ä¸‹è½½ PDF æ–‡æ¡£</button>
        </div>
        
        <!-- æŠ¥å‘Šå†…å®¹ -->
        <div class="report-container" id="reportContainer">
            <!-- åŠ¨æ€ç”Ÿæˆçš„æŠ¥å‘Šå†…å®¹å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
        </div>
    </div>
    
    <script>
        // å…¨å±€å˜é‡
        let uploadedData = null;
        let reportData = null;
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });
        
        function initializeApp() {
            // è®¾ç½®é»˜è®¤æœˆä»½ä¸ºå½“å‰æœˆä»½
            const now = new Date();
            const currentMonth = now.toISOString().slice(0, 7);
            document.getElementById('reportMonth').value = currentMonth;
            
            // ç»‘å®šäº‹ä»¶
            bindEvents();
        }
        
        function bindEvents() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');
            const generateBtn = document.getElementById('generateBtn');
            
            // æ–‡ä»¶ä¸Šä¼ äº‹ä»¶
            uploadArea.addEventListener('click', () => fileInput.click());
            uploadArea.addEventListener('dragover', handleDragOver);
            uploadArea.addEventListener('dragleave', handleDragLeave);
            uploadArea.addEventListener('drop', handleDrop);
            fileInput.addEventListener('change', handleFileSelect);
            
            // ç”ŸæˆæŠ¥å‘ŠæŒ‰é’®
            generateBtn.addEventListener('click', generateReport);
        }
        
        function handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('dragover');
        }
        
        function handleDragLeave(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('dragover');
        }
        
        function handleDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                processFile(files[0]);
            }
        }
        
        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) {
                processFile(file);
            }
        }
        
        async function processFile(file) {
            showStatus('æ­£åœ¨å¤„ç†æ–‡ä»¶...', 'info');
            
            try {
                const data = await readFile(file);
                uploadedData = data;
                
                // æ˜¾ç¤ºæ•°æ®é¢„è§ˆ
                displayDataPreview(data);
                
                // å¯ç”¨ç”ŸæˆæŒ‰é’®
                document.getElementById('generateBtn').disabled = false;
                
                showStatus(`æ–‡ä»¶ä¸Šä¼ æˆåŠŸï¼å…±è¯»å– ${data.length} æ¡è®°å½•`, 'success');
            } catch (error) {
                showStatus('æ–‡ä»¶å¤„ç†å¤±è´¥ï¼š' + error.message, 'error');
                console.error('Error processing file:', error);
            }
        }
        
        function readFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                const fileExtension = file.name.split('.').pop().toLowerCase();
                
                reader.onload = function(e) {
                    try {
                        let data;
                        
                        if (fileExtension === 'csv') {
                            // å¤„ç†CSVæ–‡ä»¶
                            const csvText = e.target.result;
                            const parsed = Papa.parse(csvText, {
                                header: true,
                                skipEmptyLines: true,
                                dynamicTyping: true
                            });
                            data = parsed.data;
                        } else if (fileExtension === 'xlsx' || fileExtension === 'xls') {
                            // å¤„ç†Excelæ–‡ä»¶
                            const workbook = XLSX.read(e.target.result, { type: 'array' });
                            const firstSheetName = workbook.SheetNames[0];
                            const worksheet = workbook.Sheets[firstSheetName];
                            data = XLSX.utils.sheet_to_json(worksheet);
                        } else {
                            throw new Error('ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼');
                        }
                        
                        resolve(data);
                    } catch (error) {
                        reject(error);
                    }
                };
                
                reader.onerror = () => reject(new Error('æ–‡ä»¶è¯»å–å¤±è´¥'));
                
                if (fileExtension === 'csv') {
                    reader.readAsText(file, 'UTF-8');
                } else {
                    reader.readAsArrayBuffer(file);
                }
            });
        }
        
        function displayDataPreview(data) {
            const previewSection = document.getElementById('previewSection');
            const dataPreview = document.getElementById('dataPreview');
            
            if (data.length === 0) {
                dataPreview.innerHTML = '<p>æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆæ•°æ®</p>';
                return;
            }
            
            // è·å–å‰10æ¡æ•°æ®ç”¨äºé¢„è§ˆ
            const previewData = data.slice(0, 10);
            const headers = Object.keys(data[0]);
            
            let tableHTML = '<table class="preview-table"><thead><tr>';
            headers.forEach(header => {
                tableHTML += `<th>${header}</th>`;
            });
            tableHTML += '</tr></thead><tbody>';
            
            previewData.forEach(row => {
                tableHTML += '<tr>';
                headers.forEach(header => {
                    tableHTML += `<td>${row[header] || ''}</td>`;
                });
                tableHTML += '</tr>';
            });
            
            tableHTML += '</tbody></table>';
            
            if (data.length > 10) {
                tableHTML += `<p style="text-align: center; margin-top: 10px; color: #666;">æ˜¾ç¤ºå‰ 10 æ¡ï¼Œå…± ${data.length} æ¡è®°å½•</p>`;
            }
            
            dataPreview.innerHTML = tableHTML;
            previewSection.style.display = 'block';
        }
        
        async function generateReport() {
            if (!uploadedData) {
                showStatus('è¯·å…ˆä¸Šä¼ æ•°æ®æ–‡ä»¶', 'error');
                return;
            }
            
            showProgress(0);
            document.getElementById('progressBar').style.display = 'block';
            
            try {
                // æ­¥éª¤1ï¼šåˆ†ææ•°æ®
                showProgress(20);
                await sleep(500);
                reportData = analyzeData(uploadedData);
                
                // æ­¥éª¤2ï¼šç”ŸæˆæŠ¥å‘ŠHTML
                showProgress(50);
                await sleep(500);
                const reportHTML = generateReportHTML(reportData);
                
                // æ­¥éª¤3ï¼šæ˜¾ç¤ºæŠ¥å‘Š
                showProgress(80);
                await sleep(500);
                displayReport(reportHTML);
                
                // æ­¥éª¤4ï¼šå®Œæˆ
                showProgress(100);
                await sleep(500);
                
                document.getElementById('downloadControls').style.display = 'block';
                showStatus('æŠ¥å‘Šç”ŸæˆæˆåŠŸï¼', 'success');
                
                // æ»šåŠ¨åˆ°æŠ¥å‘ŠåŒºåŸŸ
                document.getElementById('reportContainer').scrollIntoView({ 
                    behavior: 'smooth' 
                });
                
            } catch (error) {
                showStatus('æŠ¥å‘Šç”Ÿæˆå¤±è´¥ï¼š' + error.message, 'error');
                console.error('Error generating report:', error);
            } finally {
                setTimeout(() => {
                    document.getElementById('progressBar').style.display = 'none';
                }, 1000);
            }
        }
        
        function analyzeData(data) {
            // æ•°æ®åˆ†æé€»è¾‘
            const analysis = {
                total: data.length,
                foreign: [],
                domestic: [],
                stats: {}
            };
            
            // åˆ†ç±»æ•°æ®ï¼ˆè¿™é‡Œéœ€è¦æ ¹æ®å®é™…æ•°æ®ç»“æ„è°ƒæ•´ï¼‰
            data.forEach(item => {
                // å‡è®¾æœ‰ä¸šåŠ¡ç±»å‹å­—æ®µæˆ–è€…é€šè¿‡å…¶ä»–æ–¹å¼åŒºåˆ†å¤–è´¸å†…è´¸
                if (item['ä¸šåŠ¡ç±»å‹'] === 'å¤–è´¸' || item['å…¬å¸'] && item['å…¬å¸'].includes('Ltd') || item['å…¬å¸'] && item['å…¬å¸'].includes('Inc')) {
                    analysis.foreign.push(item);
                } else {
                    analysis.domestic.push(item);
                }
            });
            
            // ç»Ÿè®¡å„ç§çŠ¶æ€
            analysis.stats = calculateStats(data);
            
            return analysis;
        }
        
        function calculateStats(data) {
            const stats = {
                æ€»è¯¢ç›˜æ•°: data.length,
                å·²å»ºç«‹æ²Ÿé€š: 0,
                å·²å®ç›˜æŠ¥ä»·: 0,
                æœªè”ç³»ä¸Š: 0,
                æœªè”ç³»: 0,
                æ— æ•ˆ: 0,
                ä¸»è¥äº§å“: 0,
                éä¸»è¥äº§å“: 0
            };
            
            data.forEach(item => {
                const status = item['è·Ÿè¿›çŠ¶æ€'] || item['çŠ¶æ€'] || '';
                const isMain = item['æ˜¯å¦ä¸»è¥'] || item['ä¸»è¥'] || '';
                
                if (status.includes('å·²å»ºç«‹æ²Ÿé€š')) stats.å·²å»ºç«‹æ²Ÿé€š++;
                if (status.includes('å·²å®ç›˜æŠ¥ä»·')) stats.å·²å®ç›˜æŠ¥ä»·++;
                if (status.includes('æœªè”ç³»ä¸Š')) stats.æœªè”ç³»ä¸Š++;
                if (status.includes('æœªè”ç³»')) stats.æœªè”ç³»++;
                if (status.includes('æ— æ•ˆ')) stats.æ— æ•ˆ++;
                
                if (isMain === 'ä¸»è¥' || isMain === true) stats.ä¸»è¥äº§å“++;
                else stats.éä¸»è¥äº§å“++;
            });
            
            return stats;
        }
        
        function generateReportHTML(data) {
            const month = document.getElementById('reportMonth').value;
            const company = document.getElementById('companyName').value;
            const reportType = document.getElementById('reportType').value;
            
            const monthName = new Date(month + '-01').toLocaleDateString('zh-CN', { 
                year: 'numeric', 
                month: 'long' 
            });
            
            const stats = data.stats;
            const effectiveRate = Math.round((stats.å·²å»ºç«‹æ²Ÿé€š + stats.å·²å®ç›˜æŠ¥ä»·) / stats.æ€»è¯¢ç›˜æ•° * 100);
            const mainProductRate = Math.round(stats.ä¸»è¥äº§å“ / stats.æ€»è¯¢ç›˜æ•° * 100);
            
            return `
                <div class="report-header">
                    <h1>ç”µå•†æœˆæŠ¥</h1>
                    <p class="subtitle">ã€${monthName}æ•°æ®ç»Ÿè®¡ã€‘</p>
                </div>
                
                <div class="report-content">
                    <div class="section">
                        <h2 class="section-title">è¯¢ç›˜æ•°æ®ç»Ÿè®¡</h2>
                        
                        <div class="stats-grid">
                            <div class="stats-text">
                                <p><span class="highlight-number">${stats.æ€»è¯¢ç›˜æ•°}ä¸ª</span> æœ¬æœˆæ€»è¯¢ç›˜æ•°</p>
                                <p>å·²å»ºç«‹æ²Ÿé€šï¼š<strong>${stats.å·²å»ºç«‹æ²Ÿé€š}ä¸ªï¼ˆ${Math.round(stats.å·²å»ºç«‹æ²Ÿé€š/stats.æ€»è¯¢ç›˜æ•°*100)}%ï¼‰</strong></p>
                                <p>å·²å®ç›˜æŠ¥ä»·ï¼š<strong>${stats.å·²å®ç›˜æŠ¥ä»·}ä¸ªï¼ˆ${Math.round(stats.å·²å®ç›˜æŠ¥ä»·/stats.æ€»è¯¢ç›˜æ•°*100)}%ï¼‰</strong></p>
                                <hr style="margin: 15px 0; border: 1px solid #ddd;">
                                <p>æœªè”ç³»ä¸Šï¼š<strong>${stats.æœªè”ç³»ä¸Š}ä¸ªï¼ˆ${Math.round(stats.æœªè”ç³»ä¸Š/stats.æ€»è¯¢ç›˜æ•°*100)}%ï¼‰</strong></p>
                                <p>æœªè”ç³»ï¼š<strong>${stats.æœªè”ç³»}ä¸ªï¼ˆ${Math.round(stats.æœªè”ç³»/stats.æ€»è¯¢ç›˜æ•°*100)}%ï¼‰</strong></p>
                                <p>æ— æ•ˆï¼š<strong>${stats.æ— æ•ˆ}ä¸ªï¼ˆ${Math.round(stats.æ— æ•ˆ/stats.æ€»è¯¢ç›˜æ•°*100)}%ï¼‰</strong></p>
                            </div>
                            
                            <div class="chart-container">
                                <div class="pie-chart" style="background: conic-gradient(
                                    #d32f2f 0deg ${effectiveRate * 3.6}deg,
                                    #9e9e9e ${effectiveRate * 3.6}deg ${(effectiveRate + Math.round((stats.æœªè”ç³»ä¸Š + stats.æœªè”ç³»)/stats.æ€»è¯¢ç›˜æ•°*100)) * 3.6}deg,
                                    #757575 ${(effectiveRate + Math.round((stats.æœªè”ç³»ä¸Š + stats.æœªè”ç³»)/stats.æ€»è¯¢ç›˜æ•°*100)) * 3.6}deg 360deg
                                );"></div>
                                <div class="chart-legend">
                                    <div class="legend-item">
                                        <div class="legend-color" style="background: #d32f2f;"></div>
                                        <span>æœ‰æ•ˆ</span>
                                    </div>
                                    <div class="legend-item">
                                        <div class="legend-color" style="background: #9e9e9e;"></div>
                                        <span>æœªè”ç³»ä¸Š</span>
                                    </div>
                                    <div class="legend-item">
                                        <div class="legend-color" style="background: #757575;"></div>
                                        <span>å…¶ä»–</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="summary-box">
                            <div class="summary-title">æœˆåº¦æ€»ç»“</div>
                            <div class="key-metrics">
                                <div class="metric-card">
                                    <div class="metric-value">${effectiveRate}%</div>
                                    <div class="metric-label">æ€»æœ‰æ•ˆç‡</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-value">${Math.round((stats.æœªè”ç³»ä¸Š + stats.æœªè”ç³»)/stats.æ€»è¯¢ç›˜æ•°*100)}%</div>
                                    <div class="metric-label">éœ€åå¤è·Ÿè¿›</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-value">${mainProductRate}%</div>
                                    <div class="metric-label">ä¸»è¥äº§å“å æ¯”</div>
                                </div>
                            </div>
                            
                            <p>æœ¬æœˆè¯¢ç›˜<strong>${effectiveRate}%</strong>å®¢æˆ·æœ‰æ•ˆï¼Œæ˜¾ç¤ºå‡ºè‰¯å¥½çš„å¸‚åœºååº”å’Œé”€å”®å›¢é˜Ÿæ‰§è¡ŒåŠ›ã€‚</p>
                            <p>ä¸»è¥äº§å“å æ¯”<strong>${mainProductRate}%</strong>ï¼Œäº§å“èšç„¦ç­–ç•¥æ•ˆæœæ˜æ˜¾ã€‚</p>
                            <p>éœ€è¦é‡ç‚¹å…³æ³¨<strong>${Math.round((stats.æœªè”ç³»ä¸Š + stats.æœªè”ç³»)/stats.æ€»è¯¢ç›˜æ•°*100)}%</strong>çš„å¾…è·Ÿè¿›å®¢æˆ·ï¼Œæå‡æ•´ä½“è½¬åŒ–ç‡ã€‚</p>
                        </div>
                    </div>
                    
                    <div class="section">
                        <h2 class="section-title">æ”¹è¿›å»ºè®®</h2>
                        
                        <div style="background: #f1f8e9; border: 2px solid #8bc34a; border-radius: 10px; padding: 20px;">
                            <h3 style="color: #558b2f; margin-top: 0;">ä¸‹æœˆè¡ŒåŠ¨è®¡åˆ’</h3>
                            <p>1. <strong>åŠ å¼ºè·Ÿè¿›ï¼š</strong>å¯¹æœªè”ç³»å®¢æˆ·å»ºç«‹ä¸“é¡¹è·Ÿè¿›æœºåˆ¶</p>
                            <p>2. <strong>æå‡è½¬åŒ–ï¼š</strong>ä¼˜åŒ–å·²æ²Ÿé€šå®¢æˆ·çš„æŠ¥ä»·æµç¨‹</p>
                            <p>3. <strong>è´¨é‡æ§åˆ¶ï¼š</strong>ç»§ç»­ä¿æŒä¸»è¥äº§å“çš„é«˜å æ¯”</p>
                            <p>4. <strong>æ•°æ®é©±åŠ¨ï¼š</strong>å»ºç«‹å®¢æˆ·åˆ†çº§ç®¡ç†ä½“ç³»</p>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function displayReport(html) {
            const reportContainer = document.getElementById('reportContainer');
            reportContainer.innerHTML = html;
            reportContainer.style.display = 'block';
        }
        
        async function downloadAsPNG() {
            const reportContainer = document.getElementById('reportContainer');
            
            try {
                const canvas = await html2canvas(reportContainer, {
                    scale: 2,
                    useCORS: true,
                    allowTaint: false,
                    backgroundColor: '#ffffff'
                });
                
                const link = document.createElement('a');
                const month = document.getElementById('reportMonth').value;
                link.download = `${month}æœˆåº¦è¯¢ç›˜æ•°æ®ç»Ÿè®¡æŠ¥å‘Š.png`;
                link.href = canvas.toDataURL('image/png', 1.0);
                link.click();
                
                showStatus('PNG å›¾ç‰‡ä¸‹è½½æˆåŠŸï¼', 'success');
            } catch (error) {
                showStatus('PNG ä¸‹è½½å¤±è´¥ï¼š' + error.message, 'error');
            }
        }
        
        function downloadAsPDF() {
            // è¿™é‡Œå¯ä»¥æ·»åŠ PDFç”Ÿæˆé€»è¾‘
            showStatus('PDF åŠŸèƒ½å¼€å‘ä¸­...', 'info');
        }
        
        // å·¥å…·å‡½æ•°
        function showStatus(message, type) {
            const statusEl = document.getElementById('fileStatus');
            statusEl.textContent = message;
            statusEl.className = `status-message status-${type}`;
            statusEl.style.display = 'block';
            
            if (type === 'success') {
                setTimeout(() => {
                    statusEl.style.display = 'none';
                }, 3000);
            }
        }
        
        function showProgress(percent) {
            const progressFill = document.getElementById('progressFill');
            progressFill.style.width = percent + '%';
        }
        
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
    </script>
</body>
</html>
