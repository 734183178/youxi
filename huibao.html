<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Êô∫ËÉΩËØ¢ÁõòÊï∞ÊçÆÊä•ÂëäÁîüÊàêÂô®</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .header h1 {
            color: #d32f2f;
            font-size: 36px;
            margin-bottom: 10px;
        }
        
        .header p {
            color: #666;
            font-size: 18px;
        }
        
        .upload-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .upload-title {
            color: #d32f2f;
            font-size: 24px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
        }
        
        .upload-title::before {
            content: "üìä";
            margin-right: 10px;
        }
        
        .upload-area {
            border: 3px dashed #ddd;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            background: #fafafa;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .upload-area:hover {
            border-color: #d32f2f;
            background: #fff5f5;
        }
        
        .upload-area.dragover {
            border-color: #d32f2f;
            background: #fff5f5;
            transform: scale(1.02);
        }
        
        .upload-icon {
            font-size: 48px;
            margin-bottom: 20px;
        }
        
        .upload-text {
            font-size: 18px;
            color: #666;
            margin-bottom: 10px;
        }
        
        .upload-hint {
            font-size: 14px;
            color: #999;
        }
        
        .file-input {
            display: none;
        }
        
        .settings-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .setting-group {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #d32f2f;
        }
        
        .setting-label {
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
            display: block;
        }
        
        .setting-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }
        
        .setting-input:focus {
            outline: none;
            border-color: #d32f2f;
        }
        
        .generate-btn {
            background: linear-gradient(135deg, #d32f2f, #b71c1c);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: block;
            margin: 30px auto;
            min-width: 200px;
        }
        
        .generate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(211, 47, 47, 0.3);
        }
        
        .generate-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .preview-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            display: none;
        }
        
        .data-preview {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        
        .preview-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .preview-table th,
        .preview-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        .preview-table th {
            background: #f8f9fa;
            font-weight: bold;
            color: #333;
            position: sticky;
            top: 0;
        }
        
        .preview-table tr:hover {
            background: #f5f5f5;
        }
        
        .report-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow: hidden;
            display: none;
            margin-bottom: 20px;
        }
        
        .report-header {
            background: #d32f2f;
            color: white;
            text-align: center;
            padding: 40px 20px;
        }
        
        .report-header h1 {
            font-size: 48px;
            margin: 0;
            font-weight: bold;
        }
        
        .report-header .subtitle {
            font-size: 24px;
            margin: 10px 0 0 0;
            color: #ffcdd2;
        }
        
        .report-content {
            padding: 30px;
        }
        
        .section {
            margin-bottom: 40px;
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            border-left: 5px solid #d32f2f;
        }
        
        .section-title {
            color: #d32f2f;
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
        }
        
        .section-title::before {
            content: "‚ñ∂";
            margin-right: 10px;
            font-size: 20px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            align-items: center;
        }
        
        .stats-text {
            font-size: 16px;
            line-height: 1.8;
        }
        
        .highlight-number {
            color: #d32f2f;
            font-size: 32px;
            font-weight: bold;
        }
        
        .chart-container {
            position: relative;
            width: 300px;
            height: 300px;
            margin: 0 auto;
        }
        
        .pie-chart {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            position: relative;
        }
        
        .chart-legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }
        
        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 3px;
        }
        
        .summary-box {
            background: linear-gradient(135deg, #fff3e0, #ffcc02);
            border: 2px solid #ff9800;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .summary-title {
            font-size: 20px;
            font-weight: bold;
            color: #e65100;
            margin-bottom: 15px;
        }
        
        .key-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .metric-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }
        
        .metric-value {
            font-size: 28px;
            font-weight: bold;
            color: #d32f2f;
            margin-bottom: 5px;
        }
        
        .metric-label {
            font-size: 14px;
            color: #666;
        }
        
        .download-controls {
            text-align: center;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 15px;
            margin: 20px 0;
            display: none;
        }
        
        .download-btn {
            background: #4caf50;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin: 0 10px;
            transition: all 0.3s ease;
        }
        
        .download-btn:hover {
            background: #45a049;
            transform: translateY(-2px);
        }
        
        .progress-bar {
            width: 100%;
            height: 6px;
            background: #f0f0f0;
            border-radius: 3px;
            margin: 10px 0;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #d32f2f, #ff5722);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .status-message {
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            text-align: center;
        }
        
        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Â§¥ÈÉ® -->
        <div class="header">
            <h1>üöÄ Êô∫ËÉΩËØ¢ÁõòÊï∞ÊçÆÊä•ÂëäÁîüÊàêÂô®</h1>
            <p>‰∏ä‰º†ÂÆ¢Êà∑Êï∞ÊçÆÔºå‰∏ÄÈîÆÁîüÊàê‰∏ì‰∏öÊúàÂ∫¶Êä•Âëä</p>
        </div>
        
        <!-- Êñá‰ª∂‰∏ä‰º†Âå∫Âüü -->
        <div class="upload-section">
            <h2 class="upload-title">Êï∞ÊçÆ‰∏ä‰º†</h2>
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">üìÅ</div>
                <div class="upload-text">ÁÇπÂáªÈÄâÊã©Êñá‰ª∂ÊàñÊãñÊãΩÂà∞Ê≠§Â§Ñ</div>
                <div class="upload-hint">ÊîØÊåÅ Excel (.xlsx/.xls) Âíå CSV Ê†ºÂºè</div>
                <input type="file" class="file-input" id="fileInput" accept=".xlsx,.xls,.csv">
            </div>
            <div id="fileStatus" class="status-message" style="display: none;"></div>
        </div>
        
        <!-- ËÆæÁΩÆÂå∫Âüü -->
        <div class="settings-section">
            <h2 class="upload-title">Êä•ÂëäËÆæÁΩÆ</h2>
            <div class="settings-grid">
                <div class="setting-group">
                    <label class="setting-label">Êä•ÂëäÊúà‰ªΩ</label>
                    <input type="month" class="setting-input" id="reportMonth" value="">
                </div>
                <div class="setting-group">
                    <label class="setting-label">ÂÖ¨Âè∏ÂêçÁß∞</label>
                    <input type="text" class="setting-input" id="companyName" placeholder="ËØ∑ËæìÂÖ•ÂÖ¨Âè∏ÂêçÁß∞" value="Ë¥µÂÖ¨Âè∏">
                </div>
                <div class="setting-group">
                    <label class="setting-label">Êä•ÂëäÁ±ªÂûã</label>
                    <select class="setting-input" id="reportType">
                        <option value="both">Â§ñË¥∏ + ÂÜÖË¥∏</option>
                        <option value="foreign">‰ªÖÂ§ñË¥∏</option>
                        <option value="domestic">‰ªÖÂÜÖË¥∏</option>
                    </select>
                </div>
                <div class="setting-group">
                    <label class="setting-label">‰∏é‰∏äÊúàÂØπÊØî</label>
                    <select class="setting-input" id="compareMode">
                        <option value="auto">Ëá™Âä®ËÆ°ÁÆó</option>
                        <option value="manual">ÊâãÂä®ËæìÂÖ•</option>
                        <option value="none">‰∏çÊòæÁ§∫ÂØπÊØî</option>
                    </select>
                </div>
            </div>
        </div>
        
        <!-- Êï∞ÊçÆÈ¢ÑËßàÂå∫Âüü -->
        <div class="preview-section" id="previewSection">
            <h2 class="upload-title">Êï∞ÊçÆÈ¢ÑËßà</h2>
            <div class="data-preview" id="dataPreview"></div>
        </div>
        
        <!-- ÁîüÊàêÊåâÈíÆ -->
        <button class="generate-btn" id="generateBtn" disabled>
            üìä ÁîüÊàêÊä•Âëä
        </button>
        
        <!-- ËøõÂ∫¶Êù° -->
        <div class="progress-bar" id="progressBar" style="display: none;">
            <div class="progress-fill" id="progressFill"></div>
        </div>
        
        <!-- ‰∏ãËΩΩÊéßÂà∂ -->
        <div class="download-controls" id="downloadControls">
            <h3>üì• ‰∏ãËΩΩÊä•Âëä</h3>
            <button class="download-btn" onclick="downloadAsPNG()">‰∏ãËΩΩ PNG ÂõæÁâá</button>
            <button class="download-btn" onclick="downloadAsPDF()" style="background: #ff5722;">‰∏ãËΩΩ PDF ÊñáÊ°£</button>
        </div>
        
        <!-- Êä•ÂëäÂÜÖÂÆπ -->
        <div class="report-container" id="reportContainer">
            <!-- Âä®ÊÄÅÁîüÊàêÁöÑÊä•ÂëäÂÜÖÂÆπÂ∞ÜÂú®ËøôÈáåÊòæÁ§∫ -->
        </div>
    </div>
    
    <script>
        // ÂÖ®Â±ÄÂèòÈáè
        let uploadedData = null;
        let reportData = null;
        
        // ÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });
        
        function initializeApp() {
            // ËÆæÁΩÆÈªòËÆ§Êúà‰ªΩ‰∏∫ÂΩìÂâçÊúà‰ªΩ
            const now = new Date();
            const currentMonth = now.toISOString().slice(0, 7);
            document.getElementById('reportMonth').value = currentMonth;
            
            // ÁªëÂÆö‰∫ã‰ª∂
            bindEvents();
        }
        
        function bindEvents() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');
            const generateBtn = document.getElementById('generateBtn');
            
            // Êñá‰ª∂‰∏ä‰º†‰∫ã‰ª∂
            uploadArea.addEventListener('click', () => fileInput.click());
            uploadArea.addEventListener('dragover', handleDragOver);
            uploadArea.addEventListener('dragleave', handleDragLeave);
            uploadArea.addEventListener('drop', handleDrop);
            fileInput.addEventListener('change', handleFileSelect);
            
            // ÁîüÊàêÊä•ÂëäÊåâÈíÆ
            generateBtn.addEventListener('click', generateReport);
        }
        
        function handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('dragover');
        }
        
        function handleDragLeave(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('dragover');
        }
        
        function handleDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                processFile(files[0]);
            }
        }
        
        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) {
                processFile(file);
            }
        }
        
        async function processFile(file) {
            showStatus('Ê≠£Âú®Â§ÑÁêÜÊñá‰ª∂...', 'info');
            
            try {
                const data = await readFile(file);
                uploadedData = data;
                
                // ÊòæÁ§∫Êï∞ÊçÆÈ¢ÑËßà
                displayDataPreview(data);
                
                // ÂêØÁî®ÁîüÊàêÊåâÈíÆ
                document.getElementById('generateBtn').disabled = false;
                
                showStatus(`Êñá‰ª∂‰∏ä‰º†ÊàêÂäüÔºÅÂÖ±ËØªÂèñ ${data.length} Êù°ËÆ∞ÂΩï`, 'success');
            } catch (error) {
                showStatus('Êñá‰ª∂Â§ÑÁêÜÂ§±Ë¥•Ôºö' + error.message, 'error');
                console.error('Error processing file:', error);
            }
        }
        
        function readFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                const fileExtension = file.name.split('.').pop().toLowerCase();
                
                reader.onload = function(e) {
                    try {
                        let data;
                        
                        if (fileExtension === 'csv') {
                            // Â§ÑÁêÜCSVÊñá‰ª∂
                            const csvText = e.target.result;
                            const parsed = Papa.parse(csvText, {
                                header: true,
                                skipEmptyLines: true,
                                dynamicTyping: true
                            });
                            data = parsed.data;
                        } else if (fileExtension === 'xlsx' || fileExtension === 'xls') {
                            // Â§ÑÁêÜExcelÊñá‰ª∂
                            const workbook = XLSX.read(e.target.result, { type: 'array' });
                            const firstSheetName = workbook.SheetNames[0];
                            const worksheet = workbook.Sheets[firstSheetName];
                            data = XLSX.utils.sheet_to_json(worksheet);
                        } else {
                            throw new Error('‰∏çÊîØÊåÅÁöÑÊñá‰ª∂Ê†ºÂºè');
                        }
                        
                        resolve(data);
                    } catch (error) {
                        reject(error);
                    }
                };
                
                reader.onerror = () => reject(new Error('Êñá‰ª∂ËØªÂèñÂ§±Ë¥•'));
                
                if (fileExtension === 'csv') {
                    reader.readAsText(file, 'UTF-8');
                } else {
                    reader.readAsArrayBuffer(file);
                }
            });
        }
        
        function displayDataPreview(data) {
            const previewSection = document.getElementById('previewSection');
            const dataPreview = document.getElementById('dataPreview');
            
            if (data.length === 0) {
                dataPreview.innerHTML = '<p>Ê≤°ÊúâÊâæÂà∞ÊúâÊïàÊï∞ÊçÆ</p>';
                return;
            }
            
            // Ëé∑ÂèñÂâç10Êù°Êï∞ÊçÆÁî®‰∫éÈ¢ÑËßà
            const previewData = data.slice(0, 10);
            const headers = Object.keys(data[0]);
            
            let tableHTML = '<table class="preview-table"><thead><tr>';
            headers.forEach(header => {
                tableHTML += `<th>${header}</th>`;
            });
            tableHTML += '</tr></thead><tbody>';
            
            previewData.forEach(row => {
                tableHTML += '<tr>';
                headers.forEach(header => {
                    tableHTML += `<td>${row[header] || ''}</td>`;
                });
                tableHTML += '</tr>';
            });
            
            tableHTML += '</tbody></table>';
            
            if (data.length > 10) {
                tableHTML += `<p style="text-align: center; margin-top: 10px; color: #666;">ÊòæÁ§∫Ââç 10 Êù°ÔºåÂÖ± ${data.length} Êù°ËÆ∞ÂΩï</p>`;
            }
            
            dataPreview.innerHTML = tableHTML;
            previewSection.style.display = 'block';
        }
        
        async function generateReport() {
            if (!uploadedData) {
                showStatus('ËØ∑ÂÖà‰∏ä‰º†Êï∞ÊçÆÊñá‰ª∂', 'error');
                return;
            }
            
            showProgress(0);
            document.getElementById('progressBar').style.display = 'block';
            
            try {
                // Ê≠•È™§1ÔºöÂàÜÊûêÊï∞ÊçÆ
                showProgress(20);
                await sleep(500);
                reportData = analyzeData(uploadedData);
                
                // Ê≠•È™§2ÔºöÁîüÊàêÊä•ÂëäHTML
                showProgress(50);
                await sleep(500);
                const reportHTML = generateReportHTML(reportData);
                
                // Ê≠•È™§3ÔºöÊòæÁ§∫Êä•Âëä
                showProgress(80);
                await sleep(500);
                displayReport(reportHTML);
                
                // Ê≠•È™§4ÔºöÂÆåÊàê
                showProgress(100);
                await sleep(500);
                
                document.getElementById('downloadControls').style.display = 'block';
                showStatus('Êä•ÂëäÁîüÊàêÊàêÂäüÔºÅ', 'success');
                
                // ÊªöÂä®Âà∞Êä•ÂëäÂå∫Âüü
                document.getElementById('reportContainer').scrollIntoView({ 
                    behavior: 'smooth' 
                });
                
            } catch (error) {
                showStatus('Êä•ÂëäÁîüÊàêÂ§±Ë¥•Ôºö' + error.message, 'error');
                console.error('Error generating report:', error);
            } finally {
                setTimeout(() => {
                    document.getElementById('progressBar').style.display = 'none';
                }, 1000);
            }
        }
        
        function analyzeData(data) {
            // Êï∞ÊçÆÂàÜÊûêÈÄªËæë
            const analysis = {
                total: data.length,
                foreign: [],
                domestic: [],
                stats: {}
            };
            
            // ÂàÜÁ±ªÊï∞ÊçÆÔºàËøôÈáåÈúÄË¶ÅÊ†πÊçÆÂÆûÈôÖÊï∞ÊçÆÁªìÊûÑË∞ÉÊï¥Ôºâ
            data.forEach(item => {
                // ÂÅáËÆæÊúâ‰∏öÂä°Á±ªÂûãÂ≠óÊÆµÊàñËÄÖÈÄöËøáÂÖ∂‰ªñÊñπÂºèÂå∫ÂàÜÂ§ñË¥∏ÂÜÖË¥∏
                if (item['‰∏öÂä°Á±ªÂûã'] === 'Â§ñË¥∏' || item['ÂÖ¨Âè∏'] && item['ÂÖ¨Âè∏'].includes('Ltd') || item['ÂÖ¨Âè∏'] && item['ÂÖ¨Âè∏'].includes('Inc')) {
                    analysis.foreign.push(item);
                } else {
                    analysis.domestic.push(item);
                }
            });
            
            // ÁªüËÆ°ÂêÑÁßçÁä∂ÊÄÅ
            analysis.stats = calculateStats(data);
            
            return analysis;
        }
        
        function calculateStats(data) {
            const stats = {
                ÊÄªËØ¢ÁõòÊï∞: data.length,
                Â∑≤Âª∫Á´ãÊ≤üÈÄö: 0,
                Â∑≤ÂÆûÁõòÊä•‰ª∑: 0,
                Êú™ËÅîÁ≥ª‰∏ä: 0,
                Êú™ËÅîÁ≥ª: 0,
                Êó†Êïà: 0,
                ‰∏ªËê•‰∫ßÂìÅ: 0,
                Èùû‰∏ªËê•‰∫ßÂìÅ: 0
            };
            
            data.forEach(item => {
                const status = item['Ë∑üËøõÁä∂ÊÄÅ'] || item['Áä∂ÊÄÅ'] || '';
                const isMain = item['ÊòØÂê¶‰∏ªËê•'] || item['‰∏ªËê•'] || '';
                
                if (status.includes('Â∑≤Âª∫Á´ãÊ≤üÈÄö')) stats.Â∑≤Âª∫Á´ãÊ≤üÈÄö++;
                if (status.includes('Â∑≤ÂÆûÁõòÊä•‰ª∑')) stats.Â∑≤ÂÆûÁõòÊä•‰ª∑++;
                if (status.includes('Êú™ËÅîÁ≥ª‰∏ä')) stats.Êú™ËÅîÁ≥ª‰∏ä++;
                if (status.includes('Êú™ËÅîÁ≥ª')) stats.Êú™ËÅîÁ≥ª++;
                if (status.includes('Êó†Êïà')) stats.Êó†Êïà++;
                
                if (isMain === '‰∏ªËê•' || isMain === true) stats.‰∏ªËê•‰∫ßÂìÅ++;
                else stats.Èùû‰∏ªËê•‰∫ßÂìÅ++;
            });
            
            return stats;
        }
        
        function generateReportHTML(data) {
            const month = document.getElementById('reportMonth').value;
            const company = document.getElementById('companyName').value;
            const reportType = document.getElementById('reportType').value;
            
            const monthName = new Date(month + '-01').toLocaleDateString('zh-CN', { 
                year: 'numeric', 
                month: 'long' 
            });
            
            const stats = data.stats;
            const effectiveRate = Math.round((stats.Â∑≤Âª∫Á´ãÊ≤üÈÄö + stats.Â∑≤ÂÆûÁõòÊä•‰ª∑) / stats.ÊÄªËØ¢ÁõòÊï∞ * 100);
            const mainProductRate = Math.round(stats.‰∏ªËê•‰∫ßÂìÅ / stats.ÊÄªËØ¢ÁõòÊï∞ * 100);
            
            return `
                <div class="report-header">
                    <h1>ÁîµÂïÜÊúàÊä•</h1>
                    <p class="subtitle">„Äê${monthName}Êï∞ÊçÆÁªüËÆ°„Äë</p>
                </div>
                
                <div class="report-content">
                    <div class="section">
                        <h2 class="section-title">ËØ¢ÁõòÊï∞ÊçÆÁªüËÆ°</h2>
                        
                        <div class="stats-grid">
                            <div class="stats-text">
                                <p><span class="highlight-number">${stats.ÊÄªËØ¢ÁõòÊï∞}‰∏™</span> Êú¨ÊúàÊÄªËØ¢ÁõòÊï∞</p>
                                <p>Â∑≤Âª∫Á´ãÊ≤üÈÄöÔºö<strong>${stats.Â∑≤Âª∫Á´ãÊ≤üÈÄö}‰∏™Ôºà${Math.round(stats.Â∑≤Âª∫Á´ãÊ≤üÈÄö/stats.ÊÄªËØ¢ÁõòÊï∞*100)}%Ôºâ</strong></p>
                                <p>Â∑≤ÂÆûÁõòÊä•‰ª∑Ôºö<strong>${stats.Â∑≤ÂÆûÁõòÊä•‰ª∑}‰∏™Ôºà${Math.round(stats.Â∑≤ÂÆûÁõòÊä•‰ª∑/stats.ÊÄªËØ¢ÁõòÊï∞*100)}%Ôºâ</strong></p>
                                <hr style="margin: 15px 0; border: 1px solid #ddd;">
                                <p>Êú™ËÅîÁ≥ª‰∏äÔºö<strong>${stats.Êú™ËÅîÁ≥ª‰∏ä}‰∏™Ôºà${Math.round(stats.Êú™ËÅîÁ≥ª‰∏ä/stats.ÊÄªËØ¢ÁõòÊï∞*100)}%Ôºâ</strong></p>
                                <p>Êú™ËÅîÁ≥ªÔºö<strong>${stats.Êú™ËÅîÁ≥ª}‰∏™Ôºà${Math.round(stats.Êú™ËÅîÁ≥ª/stats.ÊÄªËØ¢ÁõòÊï∞*100)}%Ôºâ</strong></p>
                                <p>Êó†ÊïàÔºö<strong>${stats.Êó†Êïà}‰∏™Ôºà${Math.round(stats.Êó†Êïà/stats.ÊÄªËØ¢ÁõòÊï∞*100)}%Ôºâ</strong></p>
                            </div>
                            
                            <div class="chart-container">
                                <div class="pie-chart" style="background: conic-gradient(
                                    #d32f2f 0deg ${effectiveRate * 3.6}deg,
                                    #9e9e9e ${effectiveRate * 3.6}deg ${(effectiveRate + Math.round((stats.Êú™ËÅîÁ≥ª‰∏ä + stats.Êú™ËÅîÁ≥ª)/stats.ÊÄªËØ¢ÁõòÊï∞*100)) * 3.6}deg,
                                    #757575 ${(effectiveRate + Math.round((stats.Êú™ËÅîÁ≥ª‰∏ä + stats.Êú™ËÅîÁ≥ª)/stats.ÊÄªËØ¢ÁõòÊï∞*100)) * 3.6}deg 360deg
                                );"></div>
                                <div class="chart-legend">
                                    <div class="legend-item">
                                        <div class="legend-color" style="background: #d32f2f;"></div>
                                        <span>ÊúâÊïà</span>
                                    </div>
                                    <div class="legend-item">
                                        <div class="legend-color" style="background: #9e9e9e;"></div>
                                        <span>Êú™ËÅîÁ≥ª‰∏ä</span>
                                    </div>
                                    <div class="legend-item">
                                        <div class="legend-color" style="background: #757575;"></div>
                                        <span>ÂÖ∂‰ªñ</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="summary-box">
                            <div class="summary-title">ÊúàÂ∫¶ÊÄªÁªì</div>
                            <div class="key-metrics">
                                <div class="metric-card">
                                    <div class="metric-value">${effectiveRate}%</div>
                                    <div class="metric-label">ÊÄªÊúâÊïàÁéá</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-value">${Math.round((stats.Êú™ËÅîÁ≥ª‰∏ä + stats.Êú™ËÅîÁ≥ª)/stats.ÊÄªËØ¢ÁõòÊï∞*100)}%</div>
                                    <div class="metric-label">ÈúÄÂèçÂ§çË∑üËøõ</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-value">${mainProductRate}%</div>
                                    <div class="metric-label">‰∏ªËê•‰∫ßÂìÅÂç†ÊØî</div>
                                </div>
                            </div>
                            
                            <p>Êú¨ÊúàËØ¢Áõò<strong>${effectiveRate}%</strong>ÂÆ¢Êà∑ÊúâÊïàÔºåÊòæÁ§∫Âá∫ËâØÂ•ΩÁöÑÂ∏ÇÂú∫ÂèçÂ∫îÂíåÈîÄÂîÆÂõ¢ÈòüÊâßË°åÂäõ„ÄÇ</p>
                            <p>‰∏ªËê•‰∫ßÂìÅÂç†ÊØî<strong>${mainProductRate}%</strong>Ôºå‰∫ßÂìÅËÅöÁÑ¶Á≠ñÁï•ÊïàÊûúÊòéÊòæ„ÄÇ</p>
                            <p>ÈúÄË¶ÅÈáçÁÇπÂÖ≥Ê≥®<strong>${Math.round((stats.Êú™ËÅîÁ≥ª‰∏ä + stats.Êú™ËÅîÁ≥ª)/stats.ÊÄªËØ¢ÁõòÊï∞*100)}%</strong>ÁöÑÂæÖË∑üËøõÂÆ¢Êà∑ÔºåÊèêÂçáÊï¥‰ΩìËΩ¨ÂåñÁéá„ÄÇ</p>
                        </div>
                    </div>
                    
                    <div class="section">
                        <h2 class="section-title">ÊîπËøõÂª∫ËÆÆ</h2>
                        
                        <div style="background: #f1f8e9; border: 2px solid #8bc34a; border-radius: 10px; padding: 20px;">
                            <h3 style="color: #558b2f; margin-top: 0;">‰∏ãÊúàË°åÂä®ËÆ°Âàí</h3>
                            <p>1. <strong>Âä†Âº∫Ë∑üËøõÔºö</strong>ÂØπÊú™ËÅîÁ≥ªÂÆ¢Êà∑Âª∫Á´ã‰∏ìÈ°πË∑üËøõÊú∫Âà∂</p>
                            <p>2. <strong>ÊèêÂçáËΩ¨ÂåñÔºö</strong>‰ºòÂåñÂ∑≤Ê≤üÈÄöÂÆ¢Êà∑ÁöÑÊä•‰ª∑ÊµÅÁ®ã</p>
                            <p>3. <strong>Ë¥®ÈáèÊéßÂà∂Ôºö</strong>ÁªßÁª≠‰øùÊåÅ‰∏ªËê•‰∫ßÂìÅÁöÑÈ´òÂç†ÊØî</p>
                            <p>4. <strong>Êï∞ÊçÆÈ©±Âä®Ôºö</strong>Âª∫Á´ãÂÆ¢Êà∑ÂàÜÁ∫ßÁÆ°ÁêÜ‰ΩìÁ≥ª</p>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function displayReport(html) {
            const reportContainer = document.getElementById('reportContainer');
            reportContainer.innerHTML = html;
            reportContainer.style.display = 'block';
        }
        
        async function downloadAsPNG() {
            const reportContainer = document.getElementById('reportContainer');
            
            try {
                const canvas = await html2canvas(reportContainer, {
                    scale: 2,
                    useCORS: true,
                    allowTaint: false,
                    backgroundColor: '#ffffff'
                });
                
                const link = document.createElement('a');
                const month = document.getElementById('reportMonth').value;
                link.download = `${month}ÊúàÂ∫¶ËØ¢ÁõòÊï∞ÊçÆÁªüËÆ°Êä•Âëä.png`;
                link.href = canvas.toDataURL('image/png', 1.0);
                link.click();
                
                showStatus('PNG ÂõæÁâá‰∏ãËΩΩÊàêÂäüÔºÅ', 'success');
            } catch (error) {
                showStatus('PNG ‰∏ãËΩΩÂ§±Ë¥•Ôºö' + error.message, 'error');
            }
        }
        
        function downloadAsPDF() {
            // ËøôÈáåÂèØ‰ª•Ê∑ªÂä†PDFÁîüÊàêÈÄªËæë
            showStatus('PDF ÂäüËÉΩÂºÄÂèë‰∏≠...', 'info');
        }
        
        // Â∑•ÂÖ∑ÂáΩÊï∞
        function showStatus(message, type) {
            const statusEl = document.getElementById('fileStatus');
            statusEl.textContent = message;
            statusEl.className = `status-message status-${type}`;
            statusEl.style.display = 'block';
            
            if (type === 'success') {
                setTimeout(() => {
                    statusEl.style.display = 'none';
                }, 3000);
            }
        }
        
        function showProgress(percent) {
            const progressFill = document.getElementById('progressFill');
            progressFill.style.width = percent + '%';
        }
        
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
    </script>
</body>
</html>
