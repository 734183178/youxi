<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…‘æ¢ç ç®¡ç†åå°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <!-- å¤´éƒ¨ -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">ğŸ« å…‘æ¢ç ç®¡ç†åå°</h1>
            <p class="text-gray-600">æ‰¹é‡ç”Ÿæˆã€æŸ¥çœ‹å’Œç®¡ç†å…‘æ¢ç </p>
        </div>

        <!-- ç»Ÿè®¡ä¿¡æ¯å¡ç‰‡ -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <div class="bg-white rounded-lg shadow p-6">
                <div class="text-gray-600 text-sm mb-2">æ€»æ•°é‡</div>
                <div class="text-3xl font-bold text-blue-600" id="totalCount">-</div>
            </div>
            <div class="bg-white rounded-lg shadow p-6">
                <div class="text-gray-600 text-sm mb-2">æœªä½¿ç”¨</div>
                <div class="text-3xl font-bold text-green-600" id="unusedCount">-</div>
            </div>
            <div class="bg-white rounded-lg shadow p-6">
                <div class="text-gray-600 text-sm mb-2">å·²ä½¿ç”¨</div>
                <div class="text-3xl font-bold text-red-600" id="usedCount">-</div>
            </div>
        </div>

        <!-- æ“ä½œåŒºåŸŸ -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h2 class="text-xl font-bold text-gray-800 mb-4">æ‰¹é‡ç”Ÿæˆå…‘æ¢ç </h2>
            
            <div class="flex flex-col sm:flex-row gap-4">
                <div class="flex-1">
                    <label class="block text-sm font-medium text-gray-700 mb-2">ç”Ÿæˆæ•°é‡</label>
                    <input 
                        type="number" 
                        id="generateCount" 
                        value="10" 
                        min="1" 
                        max="1000"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        placeholder="è¾“å…¥è¦ç”Ÿæˆçš„æ•°é‡"
                    >
                </div>
                
                <div class="flex items-end">
                    <button 
                        onclick="generateCodes()"
                        id="generateBtn"
                        class="px-6 py-2 bg-blue-500 hover:bg-blue-600 text-white font-semibold rounded-lg transition-colors shadow-md"
                    >
                        ğŸ² ç”Ÿæˆå…‘æ¢ç 
                    </button>
                </div>
            </div>

            <div id="generateResult" class="mt-4 hidden">
                <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                    <h3 class="font-semibold text-green-800 mb-2">âœ… ç”ŸæˆæˆåŠŸï¼</h3>
                    <p class="text-sm text-green-700 mb-3" id="generateMessage"></p>
                    <div class="flex gap-2">
                        <button onclick="copyGeneratedCodes()" class="px-4 py-2 bg-green-500 hover:bg-green-600 text-white text-sm rounded transition-colors">
                            ğŸ“‹ å¤åˆ¶å…‘æ¢ç 
                        </button>
                        <button onclick="loadAllCodes()" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white text-sm rounded transition-colors">
                            ğŸ”„ åˆ·æ–°åˆ—è¡¨
                        </button>
                    </div>
                    <div id="generatedCodesPreview" class="mt-3 p-3 bg-white rounded border text-sm font-mono max-h-40 overflow-y-auto"></div>
                </div>
            </div>
        </div>

        <!-- å…‘æ¢ç åˆ—è¡¨ -->
        <div class="bg-white rounded-lg shadow-lg p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-800">å…‘æ¢ç åˆ—è¡¨</h2>
                <div class="flex gap-2">
                    <button onclick="loadAllCodes()" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white text-sm rounded transition-colors">
                        ğŸ”„ åˆ·æ–°
                    </button>
                    <button onclick="exportCodes()" class="px-4 py-2 bg-green-500 hover:bg-green-600 text-white text-sm rounded transition-colors">
                        ğŸ“¥ å¯¼å‡ºCSV
                    </button>
                </div>
            </div>

            <div class="mb-4 flex gap-2">
                <button onclick="filterCodes('all')" id="filterAll" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded transition-colors">
                    å…¨éƒ¨
                </button>
                <button onclick="filterCodes('unused')" id="filterUnused" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded transition-colors">
                    æœªä½¿ç”¨
                </button>
                <button onclick="filterCodes('used')" id="filterUsed" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded transition-colors">
                    å·²ä½¿ç”¨
                </button>
            </div>

            <div id="codesTable" class="overflow-x-auto">
                <div class="text-center py-8 text-gray-500">
                    <div class="loading mx-auto mb-2"></div>
                    <p>åŠ è½½ä¸­...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'https://youxi-eosin.vercel.app/api';
        const API_KEY = 'K9mP2xQ7nL4vB8wT6jF3hR5yU1cN0sA9gD';
        
        let allCodes = [];
        let generatedCodes = [];
        let currentFilter = 'all';

        // é¡µé¢åŠ è½½æ—¶è·å–ç»Ÿè®¡å’Œåˆ—è¡¨
        window.addEventListener('load', () => {
            loadStats();
            loadAllCodes();
        });

        // åŠ è½½ç»Ÿè®¡ä¿¡æ¯
        async function loadStats() {
            try {
                const response = await fetch(`${API_URL}/verify-code?action=stats`, {
                    headers: { 'X-API-KEY': API_KEY }
                });
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('totalCount').textContent = data.data.total;
                    document.getElementById('unusedCount').textContent = data.data.unused;
                    document.getElementById('usedCount').textContent = data.data.used;
                }
            } catch (error) {
                console.error('åŠ è½½ç»Ÿè®¡å¤±è´¥:', error);
            }
        }

        // ç”Ÿæˆå…‘æ¢ç 
        async function generateCodes() {
            const count = parseInt(document.getElementById('generateCount').value);
            
            if (count < 1 || count > 1000) {
                alert('è¯·è¾“å…¥1-1000ä¹‹é—´çš„æ•°é‡');
                return;
            }

            const btn = document.getElementById('generateBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span> ç”Ÿæˆä¸­...';

            try {
                const response = await fetch(`${API_URL}/generate-codes`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-KEY': API_KEY
                    },
                    body: JSON.stringify({ count: count })
                });

                const data = await response.json();
                
                if (data.success) {
                    generatedCodes = data.codes;
                    document.getElementById('generateMessage').textContent = 
                        `æˆåŠŸç”Ÿæˆ ${generatedCodes.length} ä¸ªå…‘æ¢ç `;
                    
                    const preview = generatedCodes.slice(0, 10).join('\n');
                    document.getElementById('generatedCodesPreview').textContent = 
                        preview + (generatedCodes.length > 10 ? '\n...' : '');
                    
                    document.getElementById('generateResult').classList.remove('hidden');
                    
                    loadStats();
                    loadAllCodes();
                } else {
                    alert('ç”Ÿæˆå¤±è´¥: ' + data.message);
                }
            } catch (error) {
                alert('ç”Ÿæˆå¤±è´¥: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'ğŸ² ç”Ÿæˆå…‘æ¢ç ';
            }
        }

        // å¤åˆ¶ç”Ÿæˆçš„å…‘æ¢ç 
        function copyGeneratedCodes() {
            const text = generatedCodes.join('\n');
            navigator.clipboard.writeText(text).then(() => {
                alert(`å·²å¤åˆ¶ ${generatedCodes.length} ä¸ªå…‘æ¢ç åˆ°å‰ªè´´æ¿`);
            });
        }

        // åŠ è½½æ‰€æœ‰å…‘æ¢ç 
        async function loadAllCodes() {
            try {
                const response = await fetch(`${API_URL}/list-codes`, {
                    headers: { 'X-API-KEY': API_KEY }
                });
                const data = await response.json();
                
                if (data.success) {
                    allCodes = data.codes;
                    displayCodes();
                }
            } catch (error) {
                console.error('åŠ è½½åˆ—è¡¨å¤±è´¥:', error);
                document.getElementById('codesTable').innerHTML = 
                    '<div class="text-center py-8 text-red-500">åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•</div>';
            }
        }

        // è¿‡æ»¤å…‘æ¢ç 
        function filterCodes(filter) {
            currentFilter = filter;
            
            // æ›´æ–°æŒ‰é’®æ ·å¼
            document.querySelectorAll('[id^="filter"]').forEach(btn => {
                btn.className = 'px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded transition-colors';
            });
            document.getElementById('filter' + filter.charAt(0).toUpperCase() + filter.slice(1))
                .className = 'px-4 py-2 bg-blue-500 text-white rounded';
            
            displayCodes();
        }

        // æ˜¾ç¤ºå…‘æ¢ç åˆ—è¡¨
        function displayCodes() {
            let filteredCodes = allCodes;
            
            if (currentFilter === 'unused') {
                filteredCodes = allCodes.filter(c => !c.is_used);
            } else if (currentFilter === 'used') {
                filteredCodes = allCodes.filter(c => c.is_used);
            }

            if (filteredCodes.length === 0) {
                document.getElementById('codesTable').innerHTML = 
                    '<div class="text-center py-8 text-gray-500">æš‚æ— æ•°æ®</div>';
                return;
            }

            let html = `
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">ID</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">å…‘æ¢ç </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">çŠ¶æ€</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">åˆ›å»ºæ—¶é—´</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">ä½¿ç”¨æ—¶é—´</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
            `;

            filteredCodes.forEach(code => {
                const statusBadge = code.is_used 
                    ? '<span class="px-2 py-1 text-xs rounded bg-red-100 text-red-800">å·²ä½¿ç”¨</span>'
                    : '<span class="px-2 py-1 text-xs rounded bg-green-100 text-green-800">æœªä½¿ç”¨</span>';
                
                html += `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${code.id}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-mono font-bold text-blue-600">${code.code}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">${statusBadge}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatDate(code.created_at)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${code.used_at ? formatDate(code.used_at) : '-'}</td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            document.getElementById('codesTable').innerHTML = html;
        }

        // å¯¼å‡ºCSV
        function exportCodes() {
            let csv = 'ID,å…‘æ¢ç ,çŠ¶æ€,åˆ›å»ºæ—¶é—´,ä½¿ç”¨æ—¶é—´\n';
            
            allCodes.forEach(code => {
                csv += `${code.id},${code.code},${code.is_used ? 'å·²ä½¿ç”¨' : 'æœªä½¿ç”¨'},${formatDate(code.created_at)},${code.used_at ? formatDate(code.used_at) : ''}\n`;
            });

            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
            
            link.setAttribute('href', url);
            link.setAttribute('download', `å…‘æ¢ç åˆ—è¡¨_${timestamp}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // æ ¼å¼åŒ–æ—¥æœŸ
        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
    </script>
</body>
</html>
