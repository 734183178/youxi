<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°çº¢ä¹¦å•†å“ç›‘æ§ç³»ç»Ÿ - å®æ—¶ç‰ˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 700;
        }
        
        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .status-indicator {
            position: absolute;
            top: 20px;
            right: 20px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }
        
        .status-online {
            background: rgba(46, 204, 113, 0.2);
            color: #27ae60;
            border: 2px solid rgba(46, 204, 113, 0.3);
        }
        
        .status-offline {
            background: rgba(231, 76, 60, 0.2);
            color: #e74c3c;
            border: 2px solid rgba(231, 76, 60, 0.3);
        }
        
        .warning {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            color: white;
            padding: 20px 30px;
            margin-bottom: 0;
            border-left: 5px solid #d35400;
        }
        
        .warning h4 {
            margin-bottom: 10px;
            font-size: 18px;
        }
        
        .add-section {
            padding: 30px;
            border-bottom: 1px solid #eee;
            background: #f8f9fa;
        }
        
        .add-form {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }
        
        .add-form input {
            flex: 1;
            min-width: 300px;
            padding: 12px 16px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .add-form input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }
        
        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #56ab2f, #a8e6cf);
            color: white;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
        }
        
        .btn-download {
            background: linear-gradient(135deg, #f093fb, #f5576c);
            color: white;
            padding: 8px 16px;
            font-size: 14px;
        }
        
        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            margin-right: 8px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .crawler-settings {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            border: 1px solid #e1e5e9;
        }
        
        .crawler-settings h4 {
            margin-bottom: 15px;
            color: #333;
        }
        
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .setting-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .setting-item label {
            font-size: 14px;
            font-weight: 500;
            color: #555;
        }
        
        .setting-item select,
        .setting-item input[type="number"] {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .progress-container {
            background: white;
            margin: 20px 30px;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e1e5e9;
            display: none;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #f0f0f0;
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .progress-text {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            color: #666;
        }
        
        .controls {
            padding: 20px 30px;
            background: #f8f9fa;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .sort-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .sort-controls select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .stats {
            display: flex;
            gap: 20px;
            font-size: 14px;
            color: #666;
        }
        
        .table-container {
            overflow-x: auto;
            padding: 30px;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }
        
        .data-table th {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 16px 12px;
            text-align: left;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            user-select: none;
            transition: background 0.3s;
        }
        
        .data-table th:hover {
            background: linear-gradient(135deg, #5a6fd8, #6a42a0);
        }
        
        .data-table td {
            padding: 16px 12px;
            border-bottom: 1px solid #eee;
            font-size: 14px;
            vertical-align: middle;
        }
        
        .data-table tr:hover {
            background: #f8f9fa;
        }
        
        .product-name {
            font-weight: 600;
            color: #333;
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .price {
            color: #e74c3c;
            font-weight: 700;
            font-size: 16px;
        }
        
        .sales {
            color: #27ae60;
            font-weight: 600;
        }
        
        .shop-name {
            color: #3498db;
            font-weight: 500;
        }
        
        .status-cell {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        
        .status-success {
            background: #27ae60;
        }
        
        .status-error {
            background: #e74c3c;
        }
        
        .status-pending {
            background: #f39c12;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }
        
        .empty-state h3 {
            font-size: 1.5rem;
            margin-bottom: 10px;
            color: #999;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 24px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transform: translateX(400px);
            transition: transform 0.3s;
            z-index: 1000;
            max-width: 300px;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification.success {
            background: #27ae60;
            color: white;
        }
        
        .notification.error {
            background: #e74c3c;
            color: white;
        }
        
        .notification.warning {
            background: #f39c12;
            color: white;
        }
        
        @media (max-width: 768px) {
            .add-form {
                flex-direction: column;
            }
            
            .add-form input {
                min-width: 100%;
            }
            
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .sort-controls {
                justify-content: center;
            }
            
            .stats {
                justify-content: center;
            }
            
            .settings-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>å°çº¢ä¹¦å•†å“ç›‘æ§ç³»ç»Ÿ</h1>
            <p>é›†æˆæ— å¤´æµè§ˆå™¨å®æ—¶ç›‘æ§ç«äº‰å¯¹æ‰‹å•†å“é”€é‡å˜åŒ–</p>
            <div class="status-indicator" id="systemStatus">
                <span class="status-offline">ç³»ç»Ÿç¦»çº¿</span>
            </div>
        </div>
        
        <div class="warning">
            <h4>âš ï¸ æŠ€æœ¯å®ç°è¯´æ˜</h4>
            <p>æœ¬ç³»ç»Ÿæ¼”ç¤ºäº†æ— å¤´æµè§ˆå™¨çˆ¬è™«æŠ€æœ¯ã€‚å®é™…éƒ¨ç½²éœ€è¦Node.jsæœåŠ¡å™¨ç¯å¢ƒï¼Œè¯·ç¡®ä¿éµå®ˆç›®æ ‡ç½‘ç«™çš„robots.txtå’ŒæœåŠ¡æ¡æ¬¾ã€‚å»ºè®®ä¼˜å…ˆä½¿ç”¨å®˜æ–¹APIæˆ–åˆè§„çš„ç¬¬ä¸‰æ–¹æ•°æ®æœåŠ¡ã€‚</p>
        </div>
        
        <div class="add-section">
            <div class="add-form">
                <input type="url" id="productUrl" placeholder="è¾“å…¥å°çº¢ä¹¦å•†å“é“¾æ¥..." />
                <button class="btn btn-primary" id="addBtn" onclick="addProduct()">
                    <span class="btn-text">æ·»åŠ å•†å“</span>
                </button>
                <button class="btn btn-success" id="refreshBtn" onclick="refreshAllData()">
                    <span class="btn-text">æ‰¹é‡åˆ·æ–°</span>
                </button>
                <button class="btn btn-danger" onclick="clearAllData()">æ¸…ç©ºæ•°æ®</button>
            </div>
            
            <div class="crawler-settings">
                <h4>ğŸ”§ çˆ¬è™«é…ç½®</h4>
                <div class="settings-grid">
                    <div class="setting-item">
                        <label>è¿è¡Œæ¨¡å¼</label>
                        <select id="headlessMode">
                            <option value="true">æ— å¤´æ¨¡å¼ï¼ˆå¿«é€Ÿï¼‰</option>
                            <option value="false">å¯è§†æ¨¡å¼ï¼ˆè°ƒè¯•ï¼‰</option>
                        </select>
                    </div>
                    <div class="setting-item">
                        <label>è¯·æ±‚å»¶è¿Ÿ (ç§’)</label>
                        <input type="number" id="requestDelay" value="3" min="1" max="10">
                    </div>
                    <div class="setting-item">
                        <label>é‡è¯•æ¬¡æ•°</label>
                        <input type="number" id="retryTimes" value="3" min="1" max="5">
                    </div>
                    <div class="setting-item">
                        <label>User-Agentç±»å‹</label>
                        <select id="userAgentType">
                            <option value="random">éšæœºåˆ‡æ¢</option>
                            <option value="chrome">Chrome</option>
                            <option value="firefox">Firefox</option>
                            <option value="safari">Safari</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="progress-container" id="progressContainer">
            <h4>çˆ¬å–è¿›åº¦</h4>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="progress-text">
                <span id="progressText">å‡†å¤‡å¼€å§‹...</span>
                <span id="progressPercent">0%</span>
            </div>
        </div>
        
        <div class="controls">
            <div class="sort-controls">
                <label>æ’åºæ–¹å¼ï¼š</label>
                <select id="sortBy" onchange="sortData()">
                    <option value="dailySales">å•†å“æ—¥é”€é‡</option>
                    <option value="dailyGMV">å•†å“æ—¥GMV</option>
                    <option value="price">å•†å“ä»·æ ¼</option>
                    <option value="totalSales">å•†å“æ€»é”€é‡</option>
                    <option value="shopSales">åº—é“ºé”€é‡</option>
                    <option value="shopDailySales">åº—é“ºæ—¥é”€é‡</option>
                </select>
                <select id="sortOrder" onchange="sortData()">
                    <option value="desc">é™åº</option>
                    <option value="asc">å‡åº</option>
                </select>
            </div>
            <div class="stats">
                <span>å•†å“æ€»æ•°: <strong id="totalProducts">0</strong></span>
                <span>ä»Šæ—¥æ€»GMV: <strong id="totalGMV">Â¥0</strong></span>
                <span>æˆåŠŸç‡: <strong id="successRate">--</strong></span>
                <span>æœ€åæ›´æ–°: <strong id="lastUpdate">--</strong></span>
            </div>
        </div>
        
        <div class="table-container">
            <table class="data-table" id="dataTable">
                <thead>
                    <tr>
                        <th onclick="sortBy('status')">çŠ¶æ€</th>
                        <th onclick="sortBy('productName')">å•†å“åç§°</th>
                        <th onclick="sortBy('price')">å•†å“ä»·æ ¼</th>
                        <th onclick="sortBy('dailySales')">å•†å“æ—¥é”€é‡</th>
                        <th onclick="sortBy('dailyGMV')">å•†å“æ—¥GMV</th>
                        <th onclick="sortBy('shopName')">åº—é“ºåç§°</th>
                        <th onclick="sortBy('shopSales')">åº—é“ºé”€é‡</th>
                        <th onclick="sortBy('shopDailySales')">åº—é“ºæ—¥é”€é‡</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="dataTableBody">
                </tbody>
            </table>
            <div class="empty-state" id="emptyState">
                <h3>æš‚æ— æ•°æ®</h3>
                <p>è¯·æ·»åŠ å•†å“é“¾æ¥å¼€å§‹ç›‘æ§</p>
            </div>
        </div>
    </div>
    
    <div class="notification" id="notification"></div>
    
    <script>
        // å…¨å±€å˜é‡
        let productsData = [];
        let currentSort = { field: 'dailySales', order: 'desc' };
        let crawlStats = { total: 0, success: 0, failed: 0 };
        let isSystemOnline = false;
        
        // æ¨¡æ‹Ÿçˆ¬è™«APIè°ƒç”¨
        class CrawlerAPI {
            static async crawlProduct(url, options = {}) {
                // æ¨¡æ‹Ÿç½‘ç»œè¯·æ±‚å»¶è¿Ÿ
                const delay = (options.requestDelay || 3) * 1000;
                await new Promise(resolve => setTimeout(resolve, delay));
                
                // æ¨¡æ‹ŸæˆåŠŸ/å¤±è´¥æ¦‚ç‡ï¼ˆæ¼”ç¤ºç”¨ï¼‰
                const successRate = 0.8;
                const isSuccess = Math.random() < successRate;
                
                if (!isSuccess) {
                    throw new Error('ç½‘ç»œè¿æ¥å¤±è´¥æˆ–è¢«ç›®æ ‡ç½‘ç«™é˜»æ­¢');
                }
                
                // æ¨¡æ‹Ÿè¿”å›çš„çˆ¬å–æ•°æ®
                const mockData = {
                    url: url,
                    productName: this.generateMockProductName(),
                    price: Math.floor(Math.random() * 500) + 100,
                    totalSales: Math.floor(Math.random() * 5000) + 500,
                    dailySales: Math.floor(Math.random() * 50) + 1,
                    shopName: this.generateMockShopName(),
                    shopSales: Math.floor(Math.random() * 10000) + 1000,
                    shopDailySales: Math.floor(Math.random() * 100) + 10,
                    crawlTime: new Date().toISOString(),
                    userAgent: options.userAgentType || 'random',
                    status: 'success'
                };
                
                mockData.dailyGMV = mockData.dailySales * mockData.price;
                
                return mockData;
            }
            
            static generateMockProductName() {
                const prefixes = ['è¶…å€¼', 'çƒ­é”€', 'çˆ†æ¬¾', 'é™æ—¶', 'æ–°å“'];
                const products = ['è¥é”€è¯¾ç¨‹', 'åˆ›ä¸šæŒ‡å—', 'è¿è¥ç§˜ç±', 'å“ç‰Œæ‰“é€ ', 'æµé‡å¯†ç '];
                const suffixes = ['å®æˆ˜ç­', 'è®­ç»ƒè¥', 'ä¸“ä¸šç‰ˆ', 'ç²¾åç‰ˆ', 'å®Œæ•´ç‰ˆ'];
                
                return `${prefixes[Math.floor(Math.random() * prefixes.length)]}${products[Math.floor(Math.random() * products.length)]}${suffixes[Math.floor(Math.random() * suffixes.length)]}`;
            }
            
            static generateMockShopName() {
                const names = ['è¥é”€å¤§å¸ˆå·¥ä½œå®¤', 'IPå˜ç°å­¦é™¢', 'åˆ›ä¸šåŠ é€Ÿå™¨', 'å“ç‰Œå®éªŒå®¤', 'æµé‡å·¥å‚'];
                return names[Math.floor(Math.random() * names.length)];
            }
        }
        
        // åˆå§‹åŒ–ç³»ç»Ÿ
        function initSystem() {
            // æ¨¡æ‹Ÿç³»ç»Ÿä¸Šçº¿
            setTimeout(() => {
                isSystemOnline = true;
                updateSystemStatus();
                loadDemoData();
            }, 1000);
            
            // ç»‘å®šäº‹ä»¶
            document.getElementById('productUrl').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    addProduct();
                }
            });
        }
        
        // æ›´æ–°ç³»ç»ŸçŠ¶æ€
        function updateSystemStatus() {
            const statusEl = document.getElementById('systemStatus');
            if (isSystemOnline) {
                statusEl.innerHTML = '<span class="status-online">ç³»ç»Ÿåœ¨çº¿</span>';
            } else {
                statusEl.innerHTML = '<span class="status-offline">ç³»ç»Ÿç¦»çº¿</span>';
            }
        }
        
        // åŠ è½½æ¼”ç¤ºæ•°æ®
        function loadDemoData() {
            const demoUrls = [
                'https://www.xiaohongshu.com/goods-detail/demo1',
                'https://www.xiaohongshu.com/goods-detail/demo2'
            ];
            
            demoUrls.forEach(url => {
                const mockProduct = {
                    id: Date.now() + Math.random(),
                    url: url,
                    productName: CrawlerAPI.generateMockProductName(),
                    price: Math.floor(Math.random() * 500) + 100,
                    totalSales: Math.floor(Math.random() * 5000) + 500,
                    dailySales: Math.floor(Math.random() * 50) + 1,
                    shopName: CrawlerAPI.generateMockShopName(),
                    shopSales: Math.floor(Math.random() * 10000) + 1000,
                    shopDailySales: Math.floor(Math.random() * 100) + 10,
                    status: 'success',
                    crawlTime: new Date().toISOString()
                };
                mockProduct.dailyGMV = mockProduct.dailySales * mockProduct.price;
                productsData.push(mockProduct);
            });
            
            renderTable();
            updateStats();
        }
        
        // æ˜¾ç¤ºé€šçŸ¥
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
        
        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        function updateButtonState(buttonId, loading, text) {
            const button = document.getElementById(buttonId);
            const btnText = button.querySelector('.btn-text');
            
            if (loading) {
                button.disabled = true;
                btnText.innerHTML = `<span class="loading"></span>${text}`;
            } else {
                button.disabled = false;
                btnText.textContent = text;
            }
        }
        
        // æ˜¾ç¤ºè¿›åº¦
        function showProgress(show = true) {
            const container = document.getElementById('progressContainer');
            container.style.display = show ? 'block' : 'none';
        }
        
        // æ›´æ–°è¿›åº¦
        function updateProgress(current, total, message) {
            const percent = total > 0 ? Math.round((current / total) * 100) : 0;
            document.getElementById('progressFill').style.width = percent + '%';
            document.getElementById('progressText').textContent = message;
            document.getElementById('progressPercent').textContent = percent + '%';
        }
        
        // æ·»åŠ å•†å“
        async function addProduct() {
            const urlInput = document.getElementById('productUrl');
            const url = urlInput.value.trim();
            
            if (!url) {
                showNotification('è¯·è¾“å…¥å•†å“é“¾æ¥', 'error');
                return;
            }
            
            if (!url.includes('xiaohongshu.com')) {
                showNotification('è¯·è¾“å…¥æœ‰æ•ˆçš„å°çº¢ä¹¦å•†å“é“¾æ¥', 'error');
                return;
            }
            
            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
            if (productsData.some(p => p.url === url)) {
                showNotification('è¯¥å•†å“å·²å­˜åœ¨', 'warning');
                return;
            }
            
            updateButtonState('addBtn', true, 'çˆ¬å–ä¸­');
            
            try {
                // è·å–çˆ¬è™«é…ç½®
                const options = getCrawlerOptions();
                
                // è°ƒç”¨çˆ¬è™«API
                const productData = await CrawlerAPI.crawlProduct(url, options);
                productData.id = Date.now();
                
                // æ·»åŠ åˆ°æ•°æ®ä¸­
                productsData.push(productData);
                renderTable();
                updateStats();
                
                urlInput.value = '';
                showNotification('å•†å“æ·»åŠ æˆåŠŸï¼');
                
                // æ›´æ–°ç»Ÿè®¡
                crawlStats.total++;
                crawlStats.success++;
                
            } catch (error) {
                console.error('æ·»åŠ å•†å“å¤±è´¥:', error);
                showNotification(error.message, 'error');
                
                // æ·»åŠ å¤±è´¥çš„è®°å½•
                productsData.push({
                    id: Date.now(),
                    url: url,
                    status: 'error',
                    error: error.message,
                    crawlTime: new Date().toISOString()
                });
                renderTable();
                
                crawlStats.total++;
                crawlStats.failed++;
            } finally {
                updateButtonState('addBtn', false, 'æ·»åŠ å•†å“');
            }
        }
        
        // è·å–çˆ¬è™«é…ç½®
        function getCrawlerOptions() {
            return {
                headless: document.getElementById('headlessMode').value === 'true',
                requestDelay: parseInt(document.getElementById('requestDelay').value),
                retryTimes: parseInt(document.getElementById('retryTimes').value),
                userAgentType: document.getElementById('userAgentType').value
            };
        }
        
        // æ‰¹é‡åˆ·æ–°æ•°æ®
        async function refreshAllData() {
            if (productsData.length === 0) {
                showNotification('æ²¡æœ‰å•†å“éœ€è¦åˆ·æ–°', 'warning');
                return;
            }
            
            updateButtonState('refreshBtn', true, 'åˆ·æ–°ä¸­');
            showProgress(true);
            
            const options = getCrawlerOptions();
            let completed = 0;
            const total = productsData.length;
            
            try {
                for (let i = 0; i < productsData.length; i++) {
                    const product = productsData[i];
                    updateProgress(completed, total, `æ­£åœ¨åˆ·æ–°: ${product.productName || 'å•†å“' + (i + 1)}`);
                    
                    try {
                        const newData = await CrawlerAPI.crawlProduct(product.url, options);
                        Object.assign(product, newData);
                        product.status = 'success';
                        crawlStats.success++;
                    } catch (error) {
                        product.status = 'error';
                        product.error = error.message;
                        crawlStats.failed++;
                    }
                    
                    completed++;
                    crawlStats.total++;
                    
                    // å®æ—¶æ›´æ–°è¡¨æ ¼
                    renderTable();
                    updateStats();
                }
                
                showNotification(`æ‰¹é‡åˆ·æ–°å®Œæˆï¼æˆåŠŸ: ${completed - productsData.filter(p => p.status === 'error').length}, å¤±è´¥: ${productsData.filter(p => p.status === 'error').length}`);
                
            } finally {
                updateButtonState('refreshBtn', false, 'æ‰¹é‡åˆ·æ–°');
                showProgress(false);
            }
        }
        
        // åˆ·æ–°å•ä¸ªå•†å“
        async function refreshSingleProduct(productId) {
            const product = productsData.find(p => p.id === productId);
            if (!product) return;
            
            const originalStatus = product.status;
            product.status = 'pending';
            renderTable();
            
            try {
                const options = getCrawlerOptions();
                const newData = await CrawlerAPI.crawlProduct(product.url, options);
                Object.assign(product, newData);
                product.status = 'success';
                showNotification('å•†å“æ•°æ®åˆ·æ–°æˆåŠŸï¼');
            } catch (error) {
                product.status = 'error';
                product.error = error.message;
                showNotification('åˆ·æ–°å¤±è´¥: ' + error.message, 'error');
            }
            
            renderTable();
            updateStats();
        }
        
        // åˆ é™¤å•†å“
        function deleteProduct(productId) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå•†å“å—ï¼Ÿ')) {
                productsData = productsData.filter(p => p.id !== productId);
                renderTable();
                updateStats();
                showNotification('å•†å“å·²åˆ é™¤');
            }
        }
        
        // æ¸…ç©ºæ‰€æœ‰æ•°æ®
        function clearAllData() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                productsData = [];
                crawlStats = { total: 0, success: 0, failed: 0 };
                renderTable();
                updateStats();
                showNotification('æ‰€æœ‰æ•°æ®å·²æ¸…ç©º');
            }
        }
        
        // æ¸²æŸ“è¡¨æ ¼
        function renderTable() {
            const tbody = document.getElementById('dataTableBody');
            const emptyState = document.getElementById('emptyState');
            
            if (productsData.length === 0) {
                tbody.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }
            
            emptyState.style.display = 'none';
            
            // æ’åºæ•°æ®
            const sortedData = [...productsData].sort((a, b) => {
                let aVal = a[currentSort.field] || 0;
                let bVal = b[currentSort.field] || 0;
                
                if (typeof aVal === 'string') {
                    aVal = aVal.toLowerCase();
                    bVal = bVal.toLowerCase();
                }
                
                if (currentSort.order === 'asc') {
                    return aVal > bVal ? 1 : -1;
                } else {
                    return aVal < bVal ? 1 : -1;
                }
            });
            
            tbody.innerHTML = sortedData.map(product => `
                <tr>
                    <td class="status-cell">
                        <div class="status-dot status-${product.status || 'pending'}"></div>
                        ${getStatusText(product.status)}
                    </td>
                    <td class="product-name" title="${product.productName || 'è·å–å¤±è´¥'}">${product.productName || 'è·å–å¤±è´¥'}</td>
                    <td class="price">Â¥${product.price || 0}</td>
                    <td class="sales">${product.dailySales || 0}</td>
                    <td class="price">Â¥${(product.dailyGMV || 0).toLocaleString()}</td>
                    <td class="shop-name">${product.shopName || 'æœªçŸ¥'}</td>
                    <td class="sales">${(product.shopSales || 0).toLocaleString()}</td>
                    <td class="sales">${product.shopDailySales || 0}</td>
                    <td>
                        <button class="btn btn-download" onclick="downloadData(${product.id})" style="margin-right: 5px;">
                            ä¸‹è½½
                        </button>
                        <button class="btn btn-success" onclick="refreshSingleProduct(${product.id})" style="margin-right: 5px; padding: 6px 12px; font-size: 12px;">
                            åˆ·æ–°
                        </button>
                        <button class="btn btn-danger" onclick="deleteProduct(${product.id})" style="padding: 6px 12px; font-size: 12px;">
                            åˆ é™¤
                        </button>
                    </td>
                </tr>
            `).join('');
        }
        
        // è·å–çŠ¶æ€æ–‡æœ¬
        function getStatusText(status) {
            switch(status) {
                case 'success': return 'æˆåŠŸ';
                case 'error': return 'å¤±è´¥';
                case 'pending': return 'çˆ¬å–ä¸­';
                default: return 'æœªçŸ¥';
            }
        }
        
        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        function updateStats() {
            const totalProducts = productsData.length;
            const totalGMV = productsData
                .filter(p => p.status === 'success')
                .reduce((sum, product) => sum + (product.dailyGMV || 0), 0);
            const successRate = crawlStats.total > 0 ? 
                Math.round((crawlStats.success / crawlStats.total) * 100) : 100;
            const lastUpdate = new Date().toLocaleString('zh-CN');
            
            document.getElementById('totalProducts').textContent = totalProducts;
            document.getElementById('totalGMV').textContent = 'Â¥' + totalGMV.toLocaleString();
            document.getElementById('successRate').textContent = successRate + '%';
            document.getElementById('lastUpdate').textContent = lastUpdate;
        }
        
        // æ’åºåŠŸèƒ½
        function sortData() {
            const sortBy = document.getElementById('sortBy').value;
            const sortOrder = document.getElementById('sortOrder').value;
            
            currentSort = { field: sortBy, order: sortOrder };
            renderTable();
        }
        
        function sortBy(field) {
            if (currentSort.field === field) {
                currentSort.order = currentSort.order === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.field = field;
                currentSort.order = 'desc';
            }
            
            document.getElementById('sortBy').value = field;
            document.getElementById('sortOrder').value = currentSort.order;
            
            renderTable();
        }
        
        // ä¸‹è½½æ•°æ®
        function downloadData(productId) {
            const product = productsData.find(p => p.id === productId);
            if (!product) return;
            
            // ç”Ÿæˆæ¨¡æ‹Ÿå†å²æ•°æ®
            const historyData = [];
            const days = 30; // ç”Ÿæˆ30å¤©çš„æ•°æ®
            
            for (let i = days; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];
                
                const baseSales = product.totalSales || 1000;
                const dailyChange = Math.floor(Math.random() * 20) - 10;
                const sales = Math.max(0, baseSales + dailyChange);
                
                historyData.push({
                    date: dateStr,
                    sales: sales,
                    price: product.price || 0,
                    gmv: sales * (product.price || 0)
                });
            }
            
            // åˆ›å»ºCSVå†…å®¹
            const csvContent = [
                ['æ—¥æœŸ', 'é”€é‡', 'ä»·æ ¼', 'GMV'],
                ...historyData.map(item => [item.date, item.sales, item.price, item.gmv])
            ].map(row => row.join(',')).join('\n');
            
            // ä¸‹è½½æ–‡ä»¶
            const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `${(product.productName || 'å•†å“æ•°æ®').substring(0, 20)}_å†å²æ•°æ®.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showNotification('æ•°æ®ä¸‹è½½æˆåŠŸï¼');
        }
        
        // åˆå§‹åŒ–ç³»ç»Ÿ
        document.addEventListener('DOMContentLoaded', function() {
            initSystem();
        });
    </script>
</body>
</html>
