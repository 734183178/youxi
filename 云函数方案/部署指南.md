# 腾讯云函数部署指南

## 📋 部署步骤

### 第一步: 登录腾讯云控制台

1. **访问腾讯云官网**
   - URL: https://cloud.tencent.com
   - 使用微信/QQ登录或注册账号

2. **进入云函数控制台**
   - 访问: https://console.cloud.tencent.com/scf
   - 或在控制台搜索"云函数 SCF"

---

### 第二步: 创建云函数

1. **点击"新建"按钮**
   - 选择地域: 推荐选择"广州"或"上海"
   - 创建方式: 选择"从头开始"

2. **基本配置**
   - 函数名称: `love-test-auth`
   - 运行环境: 选择 `Nodejs 18.15` 或 `Nodejs 16.13`
   - 函数类型: `事件函数`

3. **函数代码配置**
   - 提交方法: 选择"在线编辑"
   - 执行方法: `index.main_handler`
   - 代码编辑器: 将 `index.js` 文件的内容完整复制粘贴进去

4. **高级配置(可选)**
   - 内存: 128MB (最小值即可)
   - 超时时间: 3秒
   - 环境变量: 无需配置

5. **触发器配置**
   - 触发方式: `API网关触发`
   - 创建触发器: 是
   - 集成响应: **启用**
   - 鉴权方法: **免鉴权**
   - CORS: **启用**

6. **点击"完成"创建函数**

---

### 第三步: 获取API网关地址

1. **在函数详情页,点击"触发管理"标签**

2. **复制访问路径(API网关URL)**
   - 格式类似: `https://service-xxxxx-1234567890.gz.apigw.tencentcs.com/release/love-test-auth`
   - 这就是你的后端API地址

---

### 第四步: 更新前端代码

1. **打开前端项目的文件**
   - 文件路径: `src/components/AuthCodeModal.jsx`

2. **修改第21行的API地址**
   ```javascript
   // 将这一行:
   const response = await fetch('https://backend-hphwqcyq3-734183178s-projects.vercel.app/api/verify-code', {

   // 改为你的云函数地址:
   const response = await fetch('https://你的云函数地址', {
   ```

3. **提交并推送代码**
   ```bash
   cd "C:\Users\admin\Desktop\恋爱"
   git add .
   git commit -m "feat: 切换到腾讯云函数后端"
   git push origin master:main
   ```

---

### 第五步: 测试云函数

#### 方式1: 在云函数控制台测试

1. **点击"函数管理" → "函数代码"标签**

2. **点击"测试"按钮**

3. **输入测试事件模板**
   ```json
   {
     "body": "{\"code\":\"LOVE2025\"}",
     "httpMethod": "POST",
     "headers": {
       "Content-Type": "application/json"
     }
   }
   ```

4. **点击"测试运行"**
   - 应该看到返回: `{"success": true, "message": "授权码验证成功"}`

#### 方式2: 使用curl命令测试

```bash
curl -X POST "https://你的云函数地址" \
  -H "Content-Type: application/json" \
  -d '{"code":"LOVE2025"}'
```

---

## 🎯 功能说明

### 1. 验证授权码
```bash
# 请求
POST https://你的云函数地址
Content-Type: application/json

{
  "code": "LOVE2025"
}

# 响应 - 成功
{
  "success": true,
  "message": "授权码验证成功",
  "data": {
    "code": "LOVE2025",
    "validUntil": "2025-11-07T10:30:00.000Z"
  }
}

# 响应 - 失败
{
  "success": false,
  "message": "授权码无效,请检查后重试"
}
```

### 2. 生成新授权码(管理员)
```bash
POST https://你的云函数地址
Content-Type: application/json

{
  "action": "generate",
  "count": 10,
  "adminKey": "admin123"
}

# 响应
{
  "success": true,
  "message": "成功生成 10 个授权码",
  "data": ["ABC12345", "DEF67890", ...],
  "note": "注意: 云函数中生成的授权码在代码中添加后需要重新部署"
}
```

### 3. 查询授权码列表(管理员)
```bash
POST https://你的云函数地址
Content-Type: application/json

{
  "action": "list",
  "adminKey": "admin123"
}

# 响应
{
  "success": true,
  "data": {
    "total": 5,
    "codes": ["LOVE2025", "TEST1234", "DEMO5678", "SWEET001", "HEART999"]
  }
}
```

---

## 🔒 安全建议

### 1. 修改管理员密钥
在云函数代码中找到第14行:
```javascript
const ADMIN_KEY = 'admin123'; // 修改为更复杂的密钥
```

### 2. 添加新的授权码
在代码第7-13行的数组中添加:
```javascript
const VALID_CODES = [
  'LOVE2025',
  'TEST1234',
  'DEMO5678',
  'SWEET001',
  'HEART999',
  'YOUR_NEW_CODE' // 添加你的新授权码
];
```

添加后点击"部署"按钮使更改生效。

### 3. 启用访问日志
在云函数控制台启用"日志服务",可以追踪所有API调用。

---

## 💰 费用说明

### 免费额度(每月)
- **调用次数**: 100万次
- **资源使用量**: 40万GB-秒
- **外网流量**: 1GB

### 预估成本
假设每天1000次调用,每次50ms:
- 月调用: 3万次 ✅ 远低于免费额度
- **实际费用: ¥0**

---

## 🎯 优势总结

| 对比项 | Vercel方案 | 腾讯云函数 |
|--------|------------|-----------|
| **代码量** | 134行 | 30行核心代码 |
| **部署复杂度** | 需要CLI工具 | 网页控制台直接编辑 |
| **网络连接** | 可能被墙 | 国内稳定访问 |
| **费用** | 免费 | 免费 |
| **维护难度** | 中 | 低 |
| **代码可读性** | 中 | 高(极简) |

---

## ❓ 常见问题

### Q1: 云函数地址太长怎么办?
A: 可以使用腾讯云提供的自定义域名功能,绑定你自己的短域名。

### Q2: 如何防止恶意刷接口?
A: 在API网关中启用"流量控制",限制每IP每分钟调用次数。

### Q3: 授权码在哪里存储?
A: 直接存储在云函数代码中(VALID_CODES数组),简单且有效。如需持久化可接入云数据库。

### Q4: 如何追踪授权码使用情况?
A: 在云函数控制台查看"日志查询",可以看到所有API调用记录。

### Q5: 可以改为一次性授权码吗?
A: 可以!需要接入腾讯云数据库(如云数据库Redis)来记录已使用的授权码。

---

## 📞 遇到问题?

1. **检查云函数日志**: 控制台 → 函数管理 → 日志查询
2. **测试API网关**: 使用curl或Postman工具测试
3. **查看错误信息**: 浏览器F12控制台查看网络请求

---

## 🚀 部署完成检查清单

- [ ] 已创建腾讯云账号
- [ ] 已创建云函数并复制代码
- [ ] 已配置API网关触发器(免鉴权+CORS)
- [ ] 已获取云函数API地址
- [ ] 已更新前端代码中的API地址
- [ ] 已提交并推送代码到GitHub
- [ ] 已测试授权码验证功能正常工作

---

**完成以上步骤后,你的恋爱测试网站就可以使用腾讯云函数作为后端了!** 🎉
